# Gomoku Online - 完整部署配置 (游戏服务器 + AI 服务)
# 版本: 2.0.0 - 包含人机对战功能
version: '3.8'

services:
  # Node.js 游戏服务器
  gomoku:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/${GITHUB_REPOSITORY:-maserpoassr/wzq}:latest
    container_name: gomoku
    ports:
      - "3000:3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - AI_SERVICE_URL=http://ai-service:5001
    depends_on:
      ai-service:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Python AI 服务
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    image: ghcr.io/${GITHUB_REPOSITORY:-maserpoassr/wzq}-ai:latest
    container_name: gomoku-ai
    ports:
      - "5001:5001"
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - AI_CONFIG_PATH=config.yaml
    volumes:
      # 挂载模型文件 (可选，如果有预训练模型)
      - ./ai-service/models:/app/models:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # 资源限制 (AI 计算需要更多资源)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  default:
    name: gomoku-network
