<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>äº‘å¼ˆ Â· ZEN GOMOKU</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Noto+Serif+SC:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ================= 1. æ ¸å¿ƒè®¾è®¡ç³»ç»Ÿ ================= */
    :root {
      --bg-gradient: radial-gradient(circle at top right, #2c3e50 0%, #000000 100%);
      --glass-panel: rgba(30, 30, 30, 0.75);
      --glass-border: rgba(255, 255, 255, 0.1);
      --primary: #c5a059; /* é»‘é‡‘é£æ ¼æ ¸å¿ƒè‰² */
      --text-main: #e0e0e0;
      --text-muted: #888888;
      --success: #27ae60;
      --danger: #c0392b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Lato', 'Noto Serif SC', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* å™ªç‚¹çº¹ç†å¢åŠ é«˜çº§æ„Ÿ */
    body::before {
      content: ""; position: absolute; inset: 0; opacity: 0.05; pointer-events: none; z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    .app-wrapper { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100%; width: 100%; }

    /* ================= 2. é€šç”¨ç»„ä»¶ ================= */
    .glass-card {
      background: var(--glass-panel);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .btn {
      padding: 0.7rem 1.2rem; border: none; border-radius: 6px;
      font-family: 'Cinzel', sans-serif; font-weight: 700; letter-spacing: 1px;
      cursor: pointer; transition: all 0.2s; text-transform: uppercase; color: #fff;
      display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #a67c00 100%); color: #111; }
    .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text-main); }
    .btn-danger { background: rgba(192, 57, 43, 0.2); border: 1px solid rgba(192, 57, 43, 0.5); color: #e74c3c; }

    input[type="text"] {
      background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border);
      color: white; padding: 0.8rem; border-radius: 6px; outline: none; width: 100%;
      font-family: 'Noto Serif SC'; transition: 0.3s;
    }
    input[type="text"]:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }

    /* ================= 3. å¸ƒå±€ç»“æ„ ================= */
    .header { padding: 0.8rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); }
    .brand { font-family: 'Cinzel', serif; font-size: 1.4rem; background: linear-gradient(to right, #fff, #ccc); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .view-container { flex: 1; position: relative; overflow: hidden; }
    .view { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 1rem; display: flex; flex-direction: column; overflow-y: auto; }
    .view.active { opacity: 1; pointer-events: auto; z-index: 10; }

    /* å¤§å…è§†å›¾ */
    .lobby-center { max-width: 400px; margin: 10vh auto; text-align: center; width: 100%; }
    .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; max-width: 1200px; margin: 1rem auto; width: 100%; }
    .room-card { padding: 1.2rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
    .room-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .room-status { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; float: right; }
    .status-playing { color: var(--primary); background: rgba(197, 160, 89, 0.15); }
    .status-waiting { color: var(--success); background: rgba(39, 174, 96, 0.15); }

    /* æ¸¸æˆè§†å›¾ (Gridå¸ƒå±€é€‚é…ä¸‰æ ) */
    .game-layout {
      max-width: 1400px; margin: 0 auto; width: 100%; height: 100%;
      display: grid; grid-template-columns: 260px 1fr 260px; gap: 1rem; align-items: center;
    }
    
    /* ç©å®¶å¡ç‰‡ */
    .player-card { padding: 1rem; display: flex; align-items: center; gap: 0.8rem; transition: 0.3s; border-left: 3px solid transparent; background: rgba(0,0,0,0.2); }
    .player-card.active { background: linear-gradient(90deg, rgba(197,160,89,0.15), transparent); border-left-color: var(--primary); }
    .avatar { width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); position: relative; flex-shrink: 0; }
    .avatar.thinking::after {
      content: ''; position: absolute; inset: -3px; border-radius: 50%; border: 2px solid var(--primary); border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æ£‹ç›˜ */
    .board-wrapper { display: flex; justify-content: center; align-items: center; position: relative; }
    canvas { border-radius: 2px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); cursor: crosshair; touch-action: none; }

    /* å³ä¾§æ§åˆ¶é¢æ¿ */
    .control-panel { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
    .chat-box { flex: 1; background: rgba(0,0,0,0.2); border-radius: 6px; margin: 0.5rem 0; padding: 0.8rem; overflow-y: auto; font-size: 0.85rem; min-height: 150px; }
    .msg { margin-bottom: 4px; color: #bbb; word-break: break-all; line-height: 1.4; }
    .msg b { color: var(--primary); margin-right: 4px; }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: auto; }

    /* ================= 4. å¼¹çª—ä¸Toast ================= */
    /* è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å¼¹çª—å®¹å™¨ï¼Œæ›¿ä»£äº†åŸæ¥ä»£ç ä¸­4ä¸ªåˆ†å¼€çš„ modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 100; display: none; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
    .modal { background: #1a1a1a; border: 1px solid var(--glass-border); width: 90%; max-width: 360px; padding: 1.5rem; text-align: center; box-shadow: 0 0 30px rgba(197, 160, 89, 0.1); }
    .modal h2 { font-family: 'Cinzel'; color: var(--primary); margin-bottom: 0.5rem; font-size: 1.5rem; }
    
    #toast {
      position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: #000; padding: 0.6rem 1.2rem; border-radius: 4px;
      font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* ================= 5. ç§»åŠ¨ç«¯é€‚é… ================= */
    @media (max-width: 1024px) {
      .header { padding: 0.6rem 1rem; }
      .game-layout { grid-template-columns: 1fr; grid-template-rows: auto auto auto; gap: 0.5rem; padding-bottom: 1rem; }
      .board-wrapper { order: 2; margin: 0.5rem 0; }
      
      /* ç§»åŠ¨ç«¯å°†ç©å®¶ä¿¡æ¯æ”¾åœ¨ä¸€è¡Œæ˜¾ç¤º */
      #mobilePlayerBar { order: 1; display: flex; gap: 0.5rem; }
      .player-card { flex: 1; padding: 0.6rem; background: rgba(255,255,255,0.05); }
      .avatar { width: 30px; height: 30px; }
      
      .control-panel { order: 3; max-height: 35vh; }
      .chat-box { min-height: 100px; }
    }
  </style>
</head>
<body>

<div class="app-wrapper">
  <header class="header glass-card" style="border-radius: 0; margin: 0; border-top: 0; border-left: 0; border-right: 0;">
    <div class="brand">ZEN Â· GOMOKU</div>
    <div style="font-size: 0.8rem; color: var(--text-muted);">
      <span style="color: var(--success);">â—</span> åœ¨çº¿: <span id="onlineCount">0</span>
    </div>
  </header>

  <div class="view-container">
    
    <div id="lobbyView" class="view active">
      <div id="loginPanel" class="lobby-center">
        <h1 style="font-family:'Cinzel'; color:var(--primary); font-size:2.5rem; margin-bottom:0.5rem;">äº‘ å¼ˆ</h1>
        <p style="color:var(--text-muted); margin-bottom:2rem;">Strategy in Serenity</p>
        <div class="glass-card" style="padding: 2rem;">
          <input type="text" id="nicknameInput" placeholder="è¾“å…¥ä½ çš„ä»£å·" maxlength="12" style="text-align: center; margin-bottom: 1rem;">
          <button class="btn btn-primary" id="joinLobbyBtn" style="width: 100%;">è¿›å…¥å¤§å…</button>
        </div>
      </div>

      <div id="lobbyContent" style="display: none; width: 100%;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem;">
          <h2 style="font-family:'Cinzel'; color:var(--text-main);">Lobby</h2>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" id="createRoomBtn">ï¼‹ åˆ›å»º</button>
            <button class="btn btn-outline" id="quickMatchBtn">âš¡ åŒ¹é…</button>
            <button class="btn btn-outline" id="refreshBtn">â†» åˆ·æ–°</button>
          </div>
        </div>
        <div id="roomListGrid" class="room-grid"></div>
      </div>
    </div>

    <div id="gameView" class="view">
      <div class="game-layout">
        
        <div id="mobilePlayerBar">
          <div class="player-card glass-card" id="blackPlayerPanel">
            <div class="avatar" style="background: radial-gradient(circle at 30% 30%, #444, #000);"></div>
            <div style="flex:1; overflow:hidden;">
              <div style="font-size:0.7rem; color:var(--text-muted);">BLACK</div>
              <div id="blackName" style="font-weight:bold; white-space:nowrap;">-</div>
              <div id="blackTimer" style="font-family:monospace; color:var(--primary);"></div>
            </div>
          </div>
          <div class="player-card glass-card" id="whitePlayerPanel">
            <div class="avatar" style="background: radial-gradient(circle at 30% 30%, #fff, #ccc);"></div>
            <div style="flex:1; overflow:hidden;">
              <div style="font-size:0.7rem; color:var(--text-muted);">WHITE</div>
              <div id="whiteName" style="font-weight:bold; white-space:nowrap;">-</div>
              <div id="whiteTimer" style="font-family:monospace; color:var(--primary);"></div>
            </div>
          </div>
        </div>

        <div class="board-wrapper">
          <canvas id="board"></canvas>
        </div>

        <div class="glass-card control-panel" style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.5rem;">
            <span>æˆ¿é—´: <span id="roomIdDisplay">-</span></span>
            <span id="roleDisplay" style="color: var(--primary)"></span>
          </div>
          
          <div class="chat-box" id="chatMessages"></div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">
            <input type="text" id="chatInput" placeholder="å‘é€æ¶ˆæ¯..." style="padding: 0.5rem;">
            <button class="btn btn-primary" id="sendChatBtn" style="min-width: 40px;">â¤</button>
          </div>
          
          <div class="btn-grid">
            <button class="btn btn-outline" id="undoBtn">æ‚”æ£‹</button>
            <button class="btn btn-outline" id="inviteBtn">é‚€è¯·</button>
            <button class="btn btn-outline" id="swapBtn">æ¢æ–¹</button>
            <button class="btn btn-danger" id="surrenderBtn">è®¤è¾“</button>
            <button class="btn btn-danger" id="leaveRoomBtn" style="grid-column: span 2; margin-top: 0.5rem;">ç¦»å¼€æˆ¿é—´</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="commonModal">
  <div class="modal">
    <h2 id="modalTitle">æ ‡é¢˜</h2>
    <p id="modalDesc" style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.9rem;">å†…å®¹</p>
    <div id="modalInputArea" style="display: none; margin-bottom: 1rem;">
        <input type="text" id="modalInput" style="text-align: center;">
    </div>
    <div id="modalActions" style="display: flex; gap: 1rem; justify-content: center;"></div>
  </div>
</div>

<div id="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // ==================== 0. å·¥å…·å‡½æ•° ====================
  const $ = id => document.getElementById(id);
  const canvas = $('board');
  const ctx = canvas.getContext('2d');
  
  // ç®€æ˜“çš„ Toast æç¤º
  function showToast(msg) {
    const t = $('toast');
    t.textContent = msg;
    t.style.opacity = 1;
    setTimeout(() => { t.style.opacity = 0; }, 2000);
  }

  // é€šç”¨å¼¹çª—å‡½æ•°ï¼šè¿™ä¸€ä¸ªå‡½æ•°æ›¿ä»£äº†ä½ åŸæ¥çš„4ä¸ªHTMLæ¨¡æ€æ¡†
  function showModal(title, desc, actions = [], showInput = false) {
    $('modalTitle').textContent = title;
    $('modalDesc').textContent = desc;
    
    const inputArea = $('modalInputArea');
    const input = $('modalInput');
    inputArea.style.display = showInput ? 'block' : 'none';
    if(showInput) input.value = '';

    const actionContainer = $('modalActions');
    actionContainer.innerHTML = '';
    
    // å¦‚æœæ²¡æœ‰ä¼ å…¥æŒ‰é’®ï¼Œé»˜è®¤æ˜¾ç¤ºç¡®å®š
    if (actions.length === 0) {
      actions = [{ text: 'ç¡®å®š', class: 'btn-primary', onClick: () => closeModal() }];
    }
    
    actions.forEach(act => {
      const btn = document.createElement('button');
      btn.className = `btn ${act.class || 'btn-outline'}`;
      btn.textContent = act.text;
      btn.onclick = () => {
        const val = showInput ? input.value : null;
        act.onClick(val);
        if (!act.keepOpen) closeModal();
      };
      actionContainer.appendChild(btn);
    });
    
    $('commonModal').classList.add('active');
  }

  function closeModal() {
    $('commonModal').classList.remove('active');
  }

  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    $(id).classList.add('active');
    if(id === 'gameView') setTimeout(resizeBoard, 100);
  }

  // ==================== 1. çŠ¶æ€ç®¡ç† ====================
  const state = {
    socket: null,
    nickname: '',
    currentRoom: null,
    myRole: null, 
    board: null, 
    lastMove: null,
    hoverPos: null,
    boardSize: 15,
    cellSize: 0,
    padding: 0,
    turnTimer: null,     // è®¡æ—¶å™¨å¥æŸ„
    timeRemaining: 30,
    pendingRoomId: null  // é‚€è¯·é“¾æ¥ä¸­çš„æˆ¿é—´ID
  };

  // ==================== 2. Canvas æ¸²æŸ“ (ä¿ç•™é«˜çº§è´¨æ„Ÿ) ====================
  function resizeBoard() {
    const container = canvas.parentElement;
    const isMobile = window.innerWidth <= 768;
    // è®¡ç®—æ­£æ–¹å½¢å¤§å°
    const size = Math.min(container.clientWidth, isMobile ? window.innerWidth - 20 : window.innerHeight * 0.65);
    
    const dpr = window.devicePixelRatio || 1;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = size + 'px';
    canvas.style.height = size + 'px';
    
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);
    
    state.padding = size * 0.06;
    state.cellSize = (size - state.padding * 2) / (state.boardSize - 1);
    
    renderBoard();
  }

  function renderBoard() {
    const width = parseFloat(canvas.style.width);
    const height = parseFloat(canvas.style.height);

    // æœ¨çº¹èƒŒæ™¯
    const grd = ctx.createLinearGradient(0, 0, width, height);
    grd.addColorStop(0, "#eabb7b");
    grd.addColorStop(1, "#cd9b4d");
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, width, height);

    // ç½‘æ ¼çº¿
    ctx.beginPath();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#5d4037";
    for (let i = 0; i < state.boardSize; i++) {
      const pos = state.padding + i * state.cellSize;
      ctx.moveTo(state.padding, pos); ctx.lineTo(width - state.padding, pos);
      ctx.moveTo(pos, state.padding); ctx.lineTo(pos, height - state.padding);
    }
    ctx.stroke();

    // æ˜Ÿä½
    [3, 7, 11].forEach(r => [3, 7, 11].forEach(c => {
      ctx.beginPath();
      ctx.arc(state.padding + c*state.cellSize, state.padding + r*state.cellSize, 3, 0, Math.PI*2);
      ctx.fillStyle = "#5d4037";
      ctx.fill();
    }));

    // æ£‹å­
    if (state.board) {
      for (let x = 0; x < state.boardSize; x++) {
        for (let y = 0; y < state.boardSize; y++) {
          if (state.board[x][y] !== 0) drawStone(x, y, state.board[x][y]);
        }
      }
    }

    // é¢„é€‰æ¡† (ä»…å½“è½®åˆ°è‡ªå·±ä¸”æ˜¯ç©ºä½æ—¶æ˜¾ç¤º)
    if (state.hoverPos && state.myRole !== 'watcher' && state.currentRoom?.status === 'playing') {
       const isMyTurn = (state.myRole === 'black' && state.currentRoom.currentTurn === 1) || 
                        (state.myRole === 'white' && state.currentRoom.currentTurn === 2);
       if (isMyTurn && state.board[state.hoverPos.x][state.hoverPos.y] === 0) {
         drawSelection(state.hoverPos.x, state.hoverPos.y);
       }
    }

    // æœ€åä¸€æ‰‹çº¢è‰²æ ‡è®°
    if (state.lastMove) {
      const cx = state.padding + state.lastMove.x * state.cellSize;
      const cy = state.padding + state.lastMove.y * state.cellSize;
      ctx.fillStyle = "#c0392b";
      ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = "rgba(192, 57, 43, 0.8)";
      ctx.beginPath(); ctx.arc(cx, cy, state.cellSize * 0.3, 0, Math.PI*2); ctx.stroke();
    }
  }

  function drawStone(x, y, color) {
    const cx = state.padding + x * state.cellSize;
    const cy = state.padding + y * state.cellSize;
    const r = state.cellSize * 0.45;
    
    ctx.save();
    // é˜´å½±
    ctx.shadowColor = "rgba(0,0,0,0.4)"; ctx.shadowBlur = 4; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); 
    ctx.fillStyle = color === 1 ? "#000" : "#fff"; 
    ctx.fill();
    ctx.shadowColor = "transparent";

    // 3D è´¨æ„Ÿæ¸å˜
    const grad = ctx.createRadialGradient(cx - r*0.3, cy - r*0.3, r*0.1, cx, cy, r);
    if (color === 1) { // é»‘å­
      grad.addColorStop(0, "#666"); grad.addColorStop(0.3, "#222"); grad.addColorStop(1, "#000");
    } else { // ç™½å­
      grad.addColorStop(0, "#fff"); grad.addColorStop(0.3, "#f0f0f0"); grad.addColorStop(1, "#ccc");
    }
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function drawSelection(x, y) {
    const cx = state.padding + x * state.cellSize;
    const cy = state.padding + y * state.cellSize;
    const size = state.cellSize * 0.4;
    ctx.strokeStyle = "rgba(197, 160, 89, 0.8)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    // ç”»å››ä¸ªè§’
    ctx.moveTo(cx-size, cy-size+5); ctx.lineTo(cx-size, cy-size); ctx.lineTo(cx-size+5, cy-size);
    ctx.moveTo(cx+size-5, cy-size); ctx.lineTo(cx+size, cy-size); ctx.lineTo(cx+size, cy-size+5);
    ctx.moveTo(cx+size, cy+size-5); ctx.lineTo(cx+size, cy+size); ctx.lineTo(cx+size-5, cy+size);
    ctx.moveTo(cx-size+5, cy+size); ctx.lineTo(cx-size, cy+size); ctx.lineTo(cx-size, cy+size-5);
    ctx.stroke();
  }

  // ==================== 3. é€»è¾‘äº¤äº’ ====================
  function initSocket() {
    state.socket = io();

    state.socket.on('connect', () => {
      const saved = localStorage.getItem('gomoku_nick');
      if (saved) $('nicknameInput').value = saved;
    });
    
    // 1. åœ¨çº¿äººæ•°
    state.socket.on('online-count', ({count}) => $('onlineCount').textContent = count);
    
    // 2. æˆ¿é—´åˆ—è¡¨æ›´æ–°
    state.socket.on('room-list', (rooms) => {
      const grid = $('roomListGrid');
      if (rooms.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--text-muted); padding:2rem;">æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
        return;
      }
      grid.innerHTML = rooms.map(room => {
        const isFull = room.blackPlayer && room.whitePlayer;
        const canJoin = room.status === 'waiting' && !isFull;
        return `
        <div class="glass-card room-card">
          <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
            <span style="font-weight:bold; color:var(--text-main); font-family:'Cinzel'">${room.name}</span>
            <span class="room-status ${room.status === 'playing' ? 'status-playing' : 'status-waiting'}">${room.status}</span>
          </div>
          <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.8rem;">
            <div>âš« ${room.blackPlayer || 'ç©ºä½'}</div>
            <div>âšª ${room.whitePlayer || 'ç©ºä½'}</div>
            <div style="margin-top:0.3rem;">ğŸ‘ è§‚æˆ˜: ${room.watcherCount || 0}</div>
          </div>
          <div style="display:flex; gap:0.5rem;">
            ${canJoin ? `<button class="btn btn-primary" style="flex:1;" onclick="joinRoom('${room.id}')">åŠ å…¥</button>` : ''}
            <button class="btn btn-outline" style="flex:1;" onclick="watchRoom('${room.id}')">è§‚æˆ˜</button>
          </div>
        </div>
      `}).join('');
    });

    // 3. åŠ å…¥æˆ¿é—´æˆåŠŸ
    state.socket.on('room-joined', ({ room, role }) => {
      state.currentRoom = room;
      state.myRole = role;
      state.board = room.board;
      state.lastMove = room.history.length ? room.history[room.history.length-1] : null;
      
      switchView('gameView');
      updateGameUI();
    });

    // 4. æˆ¿é—´çŠ¶æ€æ›´æ–°
    state.socket.on('room-updated', (room) => {
      state.currentRoom = room;
      state.board = room.board;
      state.lastMove = room.history.length ? room.history[room.history.length-1] : null;
      updateGameUI();
      renderBoard();
    });

    // 5. è½å­äº‹ä»¶
    state.socket.on('stone-placed', ({ x, y, color }) => {
      if(state.board) {
        state.board[x][y] = color;
        state.lastMove = {x, y};
        renderBoard();
      }
    });

    // 6. æ¸¸æˆç»“æŸ
    state.socket.on('game-over', ({ winner, surrender }) => {
      stopClientTimer();
      const text = winner === 1 ? 'é»‘æ£‹è·èƒœ' : 'ç™½æ£‹è·èƒœ';
      const desc = surrender ? 'å¯¹æ–¹å·²è®¤è¾“' : 'äº”æ˜Ÿè¿ç ï¼';
      
      showModal(text, desc, [
        { text: 'å†æ¥ä¸€å±€', class: 'btn-primary', onClick: () => state.socket.emit('request-rematch', { roomId: state.currentRoom.id }), keepOpen: true },
        { text: 'ç¦»å¼€', class: 'btn-danger', onClick: () => leaveRoom() }
      ]);
    });

    // 7. èŠå¤©æ¶ˆæ¯
    state.socket.on('chat-received', ({ nickname, message }) => {
      const box = $('chatMessages');
      box.innerHTML += `<div class="msg"><b>${nickname}:</b>${message}</div>`;
      box.scrollTop = box.scrollHeight;
    });

    // 8. æ‚”æ£‹è¯·æ±‚
    state.socket.on('undo-requested', () => {
      showModal('æ‚”æ£‹è¯·æ±‚', 'å¯¹æ–¹æƒ³è¦æ‚”æ£‹ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ', [
        { text: 'åŒæ„', class: 'btn-primary', onClick: () => state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: true }) },
        { text: 'æ‹’ç»', class: 'btn-danger', onClick: () => state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: false }) }
      ]);
    });

    // 9. æ¢æ–¹è¯·æ±‚
    state.socket.on('swap-requested', () => {
       showModal('æ¢æ–¹è¯·æ±‚', 'å¯¹æ–¹è¯·æ±‚äº¤æ¢æ‰§æ£‹é¢œè‰²ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ', [
        { text: 'åŒæ„', class: 'btn-primary', onClick: () => state.socket.emit('respond-swap', { roomId: state.currentRoom.id, accept: true }) },
        { text: 'æ‹’ç»', class: 'btn-danger', onClick: () => state.socket.emit('respond-swap', { roomId: state.currentRoom.id, accept: false }) }
      ]);
    });

    // 10. å¤„ç†ç»“æœåé¦ˆ
    state.socket.on('undo-result', ({accepted}) => showToast(accepted ? 'æ‚”æ£‹æˆåŠŸ' : 'å¯¹æ–¹æ‹’ç»äº†æ‚”æ£‹'));
    state.socket.on('swap-result', ({accepted}) => {
      if(accepted) {
        state.myRole = state.myRole === 'black' ? 'white' : 'black';
        showToast('æ¢æ–¹æˆåŠŸ');
      } else {
        showToast('å¯¹æ–¹æ‹’ç»æ¢æ–¹');
      }
    });
    
    // 11. å†æ¥ä¸€å±€
    state.socket.on('rematch-start', ({swapped}) => {
      closeModal();
      showToast('æ–°å¯¹å±€å¼€å§‹ï¼');
      if(swapped) state.myRole = state.myRole === 'black' ? 'white' : 'black';
    });

    // 12. è®¡æ—¶å™¨åŒæ­¥
    state.socket.on('turn-timer-start', ({ timeLimit, currentTurn }) => {
      startClientTimer(timeLimit, currentTurn);
    });

    // é”™è¯¯å¤„ç†
    state.socket.on('error', ({message}) => showToast(message));
    state.socket.on('room-closed', () => { showToast('æˆ¿é—´å·²è§£æ•£'); leaveRoom(); });
  }

  // ==================== 4. è¾…åŠ©é€»è¾‘ ====================
  function updateGameUI() {
    const r = state.currentRoom;
    $('roomIdDisplay').textContent = r.id;
    $('roleDisplay').textContent = state.myRole === 'watcher' ? 'è§‚æˆ˜è€…' : (state.myRole === 'black' ? 'æ‰§é»‘' : 'æ‰§ç™½');

    // æ›´æ–°ç©å®¶çŠ¶æ€
    updatePlayer('black', r.players.black, r.currentTurn === 1 && r.status === 'playing');
    updatePlayer('white', r.players.white, r.currentTurn === 2 && r.status === 'playing');
    
    // æ›´æ–°å†å²æ¶ˆæ¯
    if(r.chat) {
        $('chatMessages').innerHTML = r.chat.map(m => `<div class="msg"><b>${m.nickname}:</b>${m.message}</div>`).join('');
    }
  }

  function updatePlayer(color, player, isTurn) {
    const el = $(`${color}PlayerPanel`);
    const nameEl = $(`${color}Name`);
    const timerEl = $(`${color}Timer`);
    
    if (player) {
      nameEl.textContent = player.nickname;
      el.style.opacity = 1;
    } else {
      nameEl.textContent = 'ç­‰å¾…åŠ å…¥...';
      el.style.opacity = 0.5;
    }

    if (isTurn) {
      el.classList.add('active');
      el.querySelector('.avatar').classList.add('thinking');
      // è®¡æ—¶å™¨æ–‡å­—ç”± timer function æ›´æ–°
    } else {
      el.classList.remove('active');
      el.querySelector('.avatar').classList.remove('thinking');
      timerEl.textContent = '';
    }
  }

  // å®¢æˆ·ç«¯å€’è®¡æ—¶é€»è¾‘
  function startClientTimer(timeLimit, currentTurn) {
    stopClientTimer();
    state.timeRemaining = Math.floor(timeLimit / 1000);
    
    const targetId = currentTurn === 1 ? 'blackTimer' : 'whiteTimer';
    
    state.turnTimer = setInterval(() => {
      state.timeRemaining--;
      if(state.timeRemaining >= 0) {
        $(targetId).textContent = state.timeRemaining + 's';
      }
      if (state.timeRemaining <= 0) stopClientTimer();
    }, 1000);
    
    // ç«‹å³æ˜¾ç¤ºä¸€æ¬¡
    $(targetId).textContent = state.timeRemaining + 's';
  }

  function stopClientTimer() {
    if (state.turnTimer) clearInterval(state.turnTimer);
    $('blackTimer').textContent = '';
    $('whiteTimer').textContent = '';
  }

  function joinLobby() {
    const nick = $('nicknameInput').value.trim();
    if (!nick) return showToast('è¯·è¾“å…¥æ˜µç§°');
    state.nickname = nick;
    localStorage.setItem('gomoku_nick', nick);
    state.socket.emit('join-lobby', { nickname: nick });
    
    $('loginPanel').style.display = 'none';
    $('lobbyContent').style.display = 'block';

    // å¦‚æœé“¾æ¥é‡Œå¸¦æœ‰æˆ¿é—´å·ï¼Œç™»å½•åè‡ªåŠ¨åŠ å…¥
    if (state.pendingRoomId) {
        showToast('æ­£åœ¨é€šè¿‡é‚€è¯·åŠ å…¥æˆ¿é—´...');
        joinRoom(state.pendingRoomId);
        state.pendingRoomId = null; // æ¸…é™¤ç¼“å­˜
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤åŠ å…¥
        window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  window.joinRoom = (id) => state.socket.emit('join-room', { roomId: id, asWatcher: false });
  window.watchRoom = (id) => state.socket.emit('join-room', { roomId: id, asWatcher: true }); 
  
  function leaveRoom() {
    if(state.currentRoom) state.socket.emit('leave-room', { roomId: state.currentRoom.id });
    state.currentRoom = null;
    state.board = null;
    stopClientTimer();
    switchView('lobbyView');
  }

  // ==================== 5. äº‹ä»¶ç»‘å®š ====================
  $('joinLobbyBtn').onclick = joinLobby;
  $('nicknameInput').onkeypress = (e) => e.key === 'Enter' && joinLobby();

  // å¼¹çª—åˆ›å»ºæˆ¿é—´é€»è¾‘
  $('createRoomBtn').onclick = () => {
    showModal('åˆ›å»ºæˆ¿é—´', 'è¯·è¾“å…¥æˆ¿é—´åç§°', [
        { text: 'å–æ¶ˆ', class: 'btn-outline', onClick: () => {} },
        { text: 'åˆ›å»º', class: 'btn-primary', onClick: (val) => {
            state.socket.emit('create-room', { name: val || `${state.nickname}çš„æˆ¿é—´` });
        }}
    ], true); // å¼€å¯è¾“å…¥æ¡†
    $('modalInput').focus();
  };

  $('quickMatchBtn').onclick = () => state.socket.emit('quick-match');
  $('refreshBtn').onclick = () => state.socket.emit('refresh-rooms');
  
  // èŠå¤©å‘é€
  const sendMsg = () => {
    const val = $('chatInput').value.trim();
    if(val && state.currentRoom) {
      state.socket.emit('chat-message', { roomId: state.currentRoom.id, message: val });
      $('chatInput').value = '';
    }
  };
  $('sendChatBtn').onclick = sendMsg;
  $('chatInput').onkeypress = (e) => e.key === 'Enter' && sendMsg();
  
  // æ¸¸æˆæ§åˆ¶
  $('undoBtn').onclick = () => state.socket.emit('request-undo', { roomId: state.currentRoom.id });
  $('swapBtn').onclick = () => state.socket.emit('request-swap', { roomId: state.currentRoom.id });
  $('surrenderBtn').onclick = () => { if(confirm('ç¡®å®šè®¤è¾“?')) state.socket.emit('surrender', { roomId: state.currentRoom.id }); };
  $('leaveRoomBtn').onclick = () => { if(confirm('ç¡®å®šç¦»å¼€?')) leaveRoom(); };
  
  // é‚€è¯·é“¾æ¥
  $('inviteBtn').onclick = () => {
      const url = window.location.href.split('?')[0] + '?room=' + state.currentRoom.id;
      navigator.clipboard.writeText(url).then(() => showToast('é‚€è¯·é“¾æ¥å·²å¤åˆ¶ï¼')).catch(() => showToast('å¤åˆ¶å¤±è´¥'));
  };

  // Canvas é¼ æ ‡/è§¦æ‘¸äº‹ä»¶
  const handleInput = (clientX, clientY, isClick) => {
    if(!state.currentRoom || state.currentRoom.status !== 'playing') return;
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const x = (clientX - rect.left) * (canvas.width / rect.width);
    const y = (clientY - rect.top) * (canvas.height / rect.height);
    
    const c = Math.round((x/dpr - state.padding) / state.cellSize);
    const r = Math.round((y/dpr - state.padding) / state.cellSize);
    
    if (c >= 0 && c < state.boardSize && r >= 0 && r < state.boardSize) {
      if(!state.hoverPos || state.hoverPos.x !== c || state.hoverPos.y !== r) {
        state.hoverPos = { x: c, y: r };
        renderBoard();
      }
      // å¦‚æœæ˜¯ç‚¹å‡»ï¼Œå‘é€è½å­
      if (isClick && state.myRole !== 'watcher') {
         // ç®€å•çš„é˜²æŠ–ï¼šå¦‚æœæ˜¯ç©ºä½
         if (state.board[c][r] === 0) {
           state.socket.emit('place-stone', { roomId: state.currentRoom.id, x: c, y: r });
         }
      }
    }
  };

  canvas.addEventListener('mousemove', e => handleInput(e.clientX, e.clientY, false));
  canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY, true));
  
  // çª—å£å¤§å°é€‚é…
  window.addEventListener('resize', resizeBoard);
  
  // åˆå§‹åŒ–
  initSocket();
  
  // å¤„ç† URL é‚€è¯·å‚æ•° (æ”¾åœ¨ initSocket ä¹‹å)
  const params = new URLSearchParams(window.location.search);
  const inviteRoomId = params.get('room');
  if(inviteRoomId) {
      // å­˜å…¥ stateï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥æ˜µç§°ç™»å½•åè‡ªåŠ¨è°ƒç”¨
      state.pendingRoomId = inviteRoomId;
      // åœ¨è¾“å…¥æ¡†ä¸Šæ–¹æç¤ºä¸€ä¸‹
      showToast('æ£€æµ‹åˆ°é‚€è¯·ï¼Œè¾“å…¥æ˜µç§°åè‡ªåŠ¨åŠ å…¥');
  }
  
  // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    const touch = e.touches[0];
    handleInput(touch.clientX, touch.clientY, false);
  }, { passive: false });
  
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    const touch = e.touches[0];
    handleInput(touch.clientX, touch.clientY, true);
  }, { passive: false });
  
  canvas.addEventListener('touchend', () => {
    state.hoverPos = null;
    renderBoard();
  });
  
  canvas.addEventListener('mouseleave', () => {
    state.hoverPos = null;
    renderBoard();
  });

</script>
</body>
</html>