<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <!-- å…¨é¢çš„ç§»åŠ¨ç«¯é€‚é… meta æ ‡ç­¾ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#1a1a1a">
  <!-- IE/Edge å…¼å®¹æ€§ -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>äº‘å¼ˆ Â· ZEN GOMOKU</title>
  <!-- å­—ä½“é¢„åŠ è½½ä¼˜åŒ– -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Noto+Serif+SC:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ================= 1. æ ¸å¿ƒè®¾è®¡ç³»ç»Ÿ + æµè§ˆå™¨å…¼å®¹æ€§ ================= */
    :root {
      --bg-gradient: radial-gradient(circle at top right, #2c3e50 0%, #000000 100%);
      --glass-panel: rgba(30, 30, 30, 0.75);
      --glass-border: rgba(255, 255, 255, 0.1);
      --primary: #c5a059;
      --text-main: #e0e0e0;
      --text-muted: #888888;
      --success: #27ae60;
      --danger: #c0392b;
      /* å®‰å…¨åŒºåŸŸå˜é‡ (iPhone X+) */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }

    /* CSS Reset + è·¨æµè§ˆå™¨åŸºç¡€æ ·å¼ */
    *, *::before, *::after { 
      margin: 0; padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ (Webkit) */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #d4af61; }

    /* Firefox æ»šåŠ¨æ¡ */
    * { scrollbar-width: thin; scrollbar-color: var(--primary) rgba(0,0,0,0.2); }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    body {
      font-family: 'Lato', 'Noto Serif SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      min-height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ */
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -ms-flex-direction: column;
      flex-direction: column;
      overflow: hidden;
      /* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      /* å®‰å…¨åŒºåŸŸé€‚é… */
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
      padding-left: var(--safe-area-left);
      padding-right: var(--safe-area-right);
    }
    
    /* å™ªç‚¹çº¹ç† - ä¼˜åŒ–æ€§èƒ½ */
    body::before {
      content: ""; 
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0;
      opacity: 0.05; 
      pointer-events: none; 
      z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      will-change: transform;
    }

    .app-wrapper { 
      position: relative; 
      z-index: 1; 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -ms-flex-direction: column;
      flex-direction: column; 
      height: 100%; 
      width: 100%;
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* ================= 2. é€šç”¨ç»„ä»¶ + è·¨æµè§ˆå™¨å…¼å®¹ ================= */
    .glass-card {
      background: var(--glass-panel);
      /* å¤šæµè§ˆå™¨ backdrop-filter æ”¯æŒ */
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      -webkit-box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    /* ä¸æ”¯æŒ backdrop-filter çš„æµè§ˆå™¨å›é€€ */
    @supports not ((-webkit-backdrop-filter: blur(20px)) or (backdrop-filter: blur(20px))) {
      .glass-card {
        background: rgba(30, 30, 30, 0.95);
      }
    }

    .btn {
      padding: 0.7rem 1.2rem; 
      border: none; 
      border-radius: 6px;
      font-family: 'Cinzel', serif; 
      font-weight: 700; 
      letter-spacing: 1px;
      cursor: pointer; 
      -webkit-transition: all 0.2s ease;
      -o-transition: all 0.2s ease;
      transition: all 0.2s ease; 
      text-transform: uppercase; 
      color: #fff;
      display: -webkit-inline-box;
      display: -ms-inline-flexbox;
      display: inline-flex; 
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center; 
      -webkit-box-pack: center;
      -ms-flex-pack: center;
      justify-content: center; 
      font-size: 0.85rem;
      /* è§¦æ‘¸ä¼˜åŒ– */
      min-height: 44px;
      min-width: 44px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
      touch-action: manipulation;
    }
    .btn:active { 
      -webkit-transform: scale(0.96); 
      -ms-transform: scale(0.96); 
      transform: scale(0.96); 
    }
    .btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    .btn-primary { 
      background: -webkit-gradient(linear, left top, right bottom, from(var(--primary)), to(#a67c00));
      background: -webkit-linear-gradient(top left, var(--primary) 0%, #a67c00 100%);
      background: -o-linear-gradient(top left, var(--primary) 0%, #a67c00 100%);
      background: linear-gradient(135deg, var(--primary) 0%, #a67c00 100%); 
      color: #111; 
    }
    .btn-outline { 
      background: transparent; 
      border: 1px solid rgba(255,255,255,0.2); 
      color: var(--text-main); 
    }
    .btn-danger { 
      background: rgba(192, 57, 43, 0.2); 
      border: 1px solid rgba(192, 57, 43, 0.5); 
      color: #e74c3c; 
    }

    input[type="text"] {
      background: rgba(0, 0, 0, 0.3); 
      border: 1px solid var(--glass-border);
      color: white; 
      padding: 0.8rem; 
      border-radius: 6px; 
      outline: none; 
      width: 100%;
      font-family: 'Noto Serif SC', serif; 
      font-size: 16px; /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
      -webkit-transition: all 0.3s ease;
      -o-transition: all 0.3s ease;
      transition: all 0.3s ease;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      min-height: 44px;
    }
    input[type="text"]:focus { 
      border-color: var(--primary); 
      background: rgba(0,0,0,0.5); 
    }
    input[type="text"]::-webkit-input-placeholder { color: var(--text-muted); }
    input[type="text"]::-moz-placeholder { color: var(--text-muted); }
    input[type="text"]:-ms-input-placeholder { color: var(--text-muted); }
    input[type="text"]::placeholder { color: var(--text-muted); }

    /* ================= 3. å¸ƒå±€ç»“æ„ ================= */
    .header { 
      padding: 0.8rem 1.5rem; 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between; 
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center; 
      border-bottom: 1px solid var(--glass-border);
      -ms-flex-negative: 0;
      flex-shrink: 0;
    }
    .brand { 
      font-family: 'Cinzel', serif; 
      font-size: 1.4rem; 
      background: -webkit-gradient(linear, left top, right top, from(#fff), to(#ccc));
      background: -webkit-linear-gradient(left, #fff, #ccc);
      background: -o-linear-gradient(left, #fff, #ccc);
      background: linear-gradient(to right, #fff, #ccc); 
      -webkit-background-clip: text;
      background-clip: text; 
      -webkit-text-fill-color: transparent;
      color: #fff; /* å›é€€è‰² */
    }
    
    .view-container { 
      -webkit-box-flex: 1;
      -ms-flex: 1;
      flex: 1; 
      position: relative; 
      overflow: hidden;
      min-height: 0; /* ä¿®å¤ flex å­å…ƒç´ æº¢å‡ºé—®é¢˜ */
    }
    .view { 
      position: absolute; 
      top: 0; left: 0; right: 0; bottom: 0;
      opacity: 0; 
      pointer-events: none; 
      -webkit-transition: opacity 0.3s ease;
      -o-transition: opacity 0.3s ease;
      transition: opacity 0.3s ease; 
      padding: 1rem; 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -ms-flex-direction: column;
      flex-direction: column; 
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .view.active { 
      opacity: 1; 
      pointer-events: auto; 
      z-index: 10; 
    }

    /* å¤§å…è§†å›¾ */
    .lobby-center { 
      max-width: 400px; 
      margin: 10vh auto; 
      text-align: center; 
      width: 100%;
      padding: 0 1rem;
    }
    .room-grid { 
      display: -ms-grid;
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
      gap: 1rem; 
      max-width: 1200px; 
      margin: 1rem auto; 
      width: 100%;
      padding: 0 0.5rem;
    }
    .room-card { 
      padding: 1.2rem; 
      cursor: pointer; 
      -webkit-transition: all 0.3s ease;
      -o-transition: all 0.3s ease;
      transition: all 0.3s ease; 
      position: relative; 
      overflow: hidden; 
    }
    .room-card:hover, .room-card:focus { 
      border-color: var(--primary); 
      -webkit-transform: translateY(-2px);
      -ms-transform: translateY(-2px);
      transform: translateY(-2px); 
    }
    .room-status { 
      font-size: 0.7rem; 
      padding: 2px 8px; 
      border-radius: 4px; 
      text-transform: uppercase; 
      font-weight: bold; 
      float: right; 
    }
    .status-playing { color: var(--primary); background: rgba(197, 160, 89, 0.15); }
    .status-waiting { color: var(--success); background: rgba(39, 174, 96, 0.15); }

    /* æ¸¸æˆè§†å›¾ (Gridå¸ƒå±€é€‚é…ä¸‰æ ) */
    .game-layout {
      max-width: 1400px; 
      margin: 0 auto; 
      width: 100%; 
      height: 100%;
      display: -ms-grid;
      display: grid; 
      -ms-grid-columns: 260px 1rem 1fr 1rem 260px;
      grid-template-columns: 260px 1fr 260px; 
      gap: 1rem; 
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      padding: 0.5rem;
    }
    
    /* ç©å®¶å¡ç‰‡ */
    .player-card { 
      padding: 1rem; 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center; 
      gap: 0.8rem; 
      -webkit-transition: all 0.3s ease;
      -o-transition: all 0.3s ease;
      transition: all 0.3s ease; 
      border-left: 3px solid transparent; 
      background: rgba(0,0,0,0.2); 
    }
    .player-card.active { 
      background: -webkit-gradient(linear, left top, right top, from(rgba(197,160,89,0.15)), to(transparent));
      background: -webkit-linear-gradient(left, rgba(197,160,89,0.15), transparent);
      background: -o-linear-gradient(left, rgba(197,160,89,0.15), transparent);
      background: linear-gradient(90deg, rgba(197,160,89,0.15), transparent); 
      border-left-color: var(--primary); 
    }
    .avatar { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      -webkit-box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
      position: relative; 
      -ms-flex-negative: 0;
      flex-shrink: 0; 
    }
    .avatar.thinking::after {
      content: ''; 
      position: absolute; 
      top: -3px; left: -3px; right: -3px; bottom: -3px;
      border-radius: 50%; 
      border: 2px solid var(--primary); 
      border-top-color: transparent; 
      -webkit-animation: spin 1s linear infinite;
      animation: spin 1s linear infinite;
    }
    @-webkit-keyframes spin { to { -webkit-transform: rotate(360deg); transform: rotate(360deg); } }
    @keyframes spin { to { -webkit-transform: rotate(360deg); transform: rotate(360deg); } }

    /* æ£‹ç›˜ */
    .board-wrapper { 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-box-pack: center;
      -ms-flex-pack: center;
      justify-content: center; 
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center; 
      position: relative;
      width: 100%;
      max-width: 100%;
    }
    canvas { 
      border-radius: 2px; 
      -webkit-box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
      cursor: crosshair; 
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      /* é˜²æ­¢ canvas æ¨¡ç³Š */
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    /* å³ä¾§æ§åˆ¶é¢æ¿ */
    .control-panel { 
      height: 100%; 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-box-orient: vertical;
      -webkit-box-direction: normal;
      -ms-flex-direction: column;
      flex-direction: column; 
      overflow: hidden; 
    }
    .chat-box { 
      -webkit-box-flex: 1;
      -ms-flex: 1;
      flex: 1; 
      background: rgba(0,0,0,0.2); 
      border-radius: 6px; 
      margin: 0.5rem 0; 
      padding: 0.8rem; 
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      font-size: 0.85rem; 
      min-height: 100px;
      max-height: 200px;
    }
    .msg { 
      margin-bottom: 4px; 
      color: #bbb; 
      word-break: break-all; 
      line-height: 1.4; 
    }
    .msg b { color: var(--primary); margin-right: 4px; }
    
    .btn-grid { 
      display: -ms-grid;
      display: grid; 
      -ms-grid-columns: 1fr 0.5rem 1fr;
      grid-template-columns: 1fr 1fr; 
      gap: 0.5rem; 
      margin-top: auto; 
    }

    /* ================= 4. å¼¹çª—ä¸Toast ================= */
    .modal-overlay { 
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); 
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px); 
      z-index: 100; 
      display: none; 
      -webkit-box-pack: center;
      -ms-flex-pack: center;
      justify-content: center; 
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      padding: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left);
    }
    .modal-overlay.active { 
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex; 
      -webkit-animation: fadeIn 0.2s ease;
      animation: fadeIn 0.2s ease; 
    }
    @-webkit-keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .modal { 
      background: #1a1a1a; 
      border: 1px solid var(--glass-border); 
      width: 90%; 
      max-width: 360px; 
      padding: 1.5rem; 
      text-align: center; 
      -webkit-box-shadow: 0 0 30px rgba(197, 160, 89, 0.1);
      box-shadow: 0 0 30px rgba(197, 160, 89, 0.1);
      border-radius: 12px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 { 
      font-family: 'Cinzel', serif; 
      color: var(--primary); 
      margin-bottom: 0.5rem; 
      font-size: 1.5rem; 
    }
    
    #toast {
      position: fixed; 
      top: 15%; 
      left: 50%; 
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      background: var(--primary); 
      color: #000; 
      padding: 0.6rem 1.2rem; 
      border-radius: 4px;
      font-weight: bold; 
      opacity: 0; 
      pointer-events: none; 
      -webkit-transition: opacity 0.3s ease;
      -o-transition: opacity 0.3s ease;
      transition: opacity 0.3s ease; 
      z-index: 200;
      -webkit-box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 90%;
      text-align: center;
      word-break: break-word;
    }

    /* ================= 5. å“åº”å¼è®¾è®¡ - å¤šè®¾å¤‡é€‚é… ================= */
    
    /* å¹³æ¿æ¨ªå± */
    @media (max-width: 1200px) and (min-width: 769px) {
      .game-layout { 
        -ms-grid-columns: 220px 1rem 1fr 1rem 220px;
        grid-template-columns: 220px 1fr 220px; 
        gap: 0.8rem;
      }
      .player-card { padding: 0.8rem; }
      .avatar { width: 35px; height: 35px; }
    }

    /* å¹³æ¿ç«–å±å’Œå¤§æ‰‹æœº */
    @media (max-width: 1024px) {
      .header { padding: 0.6rem 1rem; }
      .game-layout { 
        -ms-grid-columns: 1fr;
        grid-template-columns: 1fr; 
        -ms-grid-rows: auto auto auto;
        grid-template-rows: auto auto auto; 
        gap: 0.5rem; 
        padding: 0.5rem;
        padding-bottom: calc(1rem + var(--safe-area-bottom));
        height: auto;
        min-height: 100%;
      }
      .board-wrapper { 
        -webkit-box-ordinal-group: 3;
        -ms-flex-order: 2;
        order: 2; 
        margin: 0.5rem 0;
        padding: 0 0.5rem;
      }
      
      #mobilePlayerBar { 
        -webkit-box-ordinal-group: 2;
        -ms-flex-order: 1;
        order: 1; 
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex; 
        gap: 0.5rem;
        padding: 0 0.5rem;
      }
      .player-card { 
        -webkit-box-flex: 1;
        -ms-flex: 1;
        flex: 1; 
        padding: 0.6rem; 
        background: rgba(255,255,255,0.05); 
      }
      .avatar { width: 30px; height: 30px; }
      
      .control-panel { 
        -webkit-box-ordinal-group: 4;
        -ms-flex-order: 3;
        order: 3; 
        max-height: 35vh;
        margin: 0 0.5rem;
      }
      .chat-box { min-height: 80px; max-height: 120px; }
    }

    /* æ‰‹æœºç«–å± */
    @media (max-width: 768px) {
      html { font-size: 14px; }
      .header { padding: 0.5rem 0.8rem; }
      .brand { font-size: 1.2rem; }
      .lobby-center { margin: 5vh auto; }
      .lobby-center h1 { font-size: 2rem; }
      .room-grid { 
        grid-template-columns: 1fr; 
        gap: 0.8rem;
      }
      .game-layout { gap: 0.4rem; }
      .control-panel { max-height: 40vh; }
      .btn { 
        padding: 0.6rem 1rem; 
        font-size: 0.75rem;
        min-height: 40px;
      }
      .btn-grid { gap: 0.4rem; }
      .chat-box { 
        min-height: 60px; 
        max-height: 100px;
        font-size: 0.8rem;
      }
    }

    /* å°æ‰‹æœº */
    @media (max-width: 375px) {
      html { font-size: 13px; }
      .header { padding: 0.4rem 0.6rem; }
      .brand { font-size: 1rem; }
      .lobby-center { margin: 3vh auto; padding: 0 0.5rem; }
      .lobby-center h1 { font-size: 1.6rem; }
      .player-card { padding: 0.4rem; gap: 0.4rem; }
      .avatar { width: 24px; height: 24px; }
      .control-panel { max-height: 45vh; }
      .btn { 
        padding: 0.5rem 0.8rem; 
        font-size: 0.7rem;
        min-height: 36px;
      }
    }

    /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
    @media (max-height: 500px) and (orientation: landscape) {
      .lobby-center { margin: 2vh auto; }
      .lobby-center h1 { font-size: 1.5rem; margin-bottom: 0.3rem; }
      .lobby-center p { margin-bottom: 1rem; }
      .game-layout {
        -ms-grid-columns: 180px 0.5rem 1fr 0.5rem 180px;
        grid-template-columns: 180px 1fr 180px;
        -ms-grid-rows: 1fr;
        grid-template-rows: 1fr;
        gap: 0.5rem;
        height: 100%;
      }
      #mobilePlayerBar {
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        -webkit-box-ordinal-group: 1;
        -ms-flex-order: 0;
        order: 0;
      }
      .board-wrapper { 
        -webkit-box-ordinal-group: 2;
        -ms-flex-order: 1;
        order: 1; 
      }
      .control-panel { 
        -webkit-box-ordinal-group: 3;
        -ms-flex-order: 2;
        order: 2;
        max-height: none;
      }
      .chat-box { max-height: 80px; }
      .player-card { padding: 0.4rem; }
      .avatar { width: 24px; height: 24px; }
    }

    /* é«˜åˆ†è¾¨ç‡å±å¹• */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .glass-card {
        border-width: 0.5px;
      }
    }

    /* å‡å°‘åŠ¨ç”» (ç”¨æˆ·åå¥½) */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        -webkit-animation-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
        -webkit-transition-duration: 0.01ms !important;
        -o-transition-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* æ·±è‰²æ¨¡å¼æ”¯æŒ (å·²ç»æ˜¯æ·±è‰²ä¸»é¢˜) */
    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme: dark;
      }
    }

    /* æ‰“å°æ ·å¼ */
    @media print {
      body { background: white; color: black; }
      .glass-card { background: white; border: 1px solid #ccc; }
      .btn { background: #eee; color: black; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>

<div class="app-wrapper">
  <header class="header glass-card" style="border-radius: 0; margin: 0; border-top: 0; border-left: 0; border-right: 0;">
    <div class="brand">ZEN Â· GOMOKU</div>
    <div style="font-size: 0.8rem; color: var(--text-muted);">
      <span style="color: var(--success);">â—</span> åœ¨çº¿: <span id="onlineCount">0</span>
    </div>
  </header>

  <div class="view-container">
    
    <div id="lobbyView" class="view active">
      <div id="loginPanel" class="lobby-center">
        <h1 style="font-family:'Cinzel'; color:var(--primary); font-size:2.5rem; margin-bottom:0.5rem;">äº‘ å¼ˆ</h1>
        <p style="color:var(--text-muted); margin-bottom:2rem;">Strategy in Serenity</p>
        <div class="glass-card" style="padding: 2rem;">
          <input type="text" id="nicknameInput" placeholder="è¾“å…¥ä½ çš„ä»£å·" maxlength="12" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" style="text-align: center; margin-bottom: 1rem;">
          <button class="btn btn-primary" id="joinLobbyBtn" style="width: 100%;">è¿›å…¥å¤§å…</button>
        </div>
      </div>

      <div id="lobbyContent" style="display: none; width: 100%;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 0.5rem; gap: 0.5rem;">
          <h2 style="font-family:'Cinzel'; color:var(--text-main);">Lobby</h2>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button class="btn btn-primary" id="createRoomBtn">ï¼‹ åˆ›å»º</button>
            <button class="btn btn-outline" id="quickMatchBtn">âš¡ åŒ¹é…</button>
            <button class="btn btn-outline" id="refreshBtn">â†» åˆ·æ–°</button>
          </div>
        </div>
        <div id="roomListGrid" class="room-grid"></div>
      </div>
    </div>

    <div id="gameView" class="view">
      <div class="game-layout">
        
        <div id="mobilePlayerBar">
          <div class="player-card glass-card" id="blackPlayerPanel">
            <div class="avatar" style="background: radial-gradient(circle at 30% 30%, #444, #000);"></div>
            <div style="flex:1; overflow:hidden; min-width: 0;">
              <div style="font-size:0.7rem; color:var(--text-muted);">BLACK</div>
              <div id="blackName" style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">-</div>
              <div id="blackTimer" style="font-family:monospace; color:var(--primary);"></div>
            </div>
          </div>
          <div class="player-card glass-card" id="whitePlayerPanel">
            <div class="avatar" style="background: radial-gradient(circle at 30% 30%, #fff, #ccc);"></div>
            <div style="flex:1; overflow:hidden; min-width: 0;">
              <div style="font-size:0.7rem; color:var(--text-muted);">WHITE</div>
              <div id="whiteName" style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">-</div>
              <div id="whiteTimer" style="font-family:monospace; color:var(--primary);"></div>
            </div>
          </div>
        </div>

        <div class="board-wrapper">
          <canvas id="board"></canvas>
        </div>

        <div class="glass-card control-panel" style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.3rem;">
            <span>æˆ¿é—´: <span id="roomIdDisplay" style="word-break: break-all;">-</span></span>
            <span id="roleDisplay" style="color: var(--primary)"></span>
          </div>
          
          <div class="chat-box" id="chatMessages"></div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">
            <input type="text" id="chatInput" placeholder="å‘é€æ¶ˆæ¯..." autocomplete="off" style="padding: 0.5rem; flex: 1; min-width: 0;">
            <button class="btn btn-primary" id="sendChatBtn" style="min-width: 44px; flex-shrink: 0;">â¤</button>
          </div>
          
          <div class="btn-grid">
            <button class="btn btn-outline" id="undoBtn">æ‚”æ£‹</button>
            <button class="btn btn-outline" id="inviteBtn">é‚€è¯·</button>
            <button class="btn btn-outline" id="swapBtn">æ¢æ–¹</button>
            <button class="btn btn-danger" id="surrenderBtn">è®¤è¾“</button>
            <button class="btn btn-danger" id="leaveRoomBtn" style="grid-column: span 2; margin-top: 0.5rem;">ç¦»å¼€æˆ¿é—´</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="commonModal">
  <div class="modal">
    <h2 id="modalTitle">æ ‡é¢˜</h2>
    <p id="modalDesc" style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.9rem;">å†…å®¹</p>
    <div id="modalInputArea" style="display: none; margin-bottom: 1rem;">
        <input type="text" id="modalInput" autocomplete="off" style="text-align: center;">
    </div>
    <div id="modalActions" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;"></div>
  </div>
</div>

<div id="toast" role="alert" aria-live="polite"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // ==================== 0. å·¥å…·å‡½æ•° + æµè§ˆå™¨å…¼å®¹æ€§ ====================
  const $ = id => document.getElementById(id);
  const canvas = $('board');
  const ctx = canvas.getContext('2d');
  
  // æ£€æµ‹è®¾å¤‡ç±»å‹
  const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isAndroid = /Android/.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  
  // ç®€æ˜“çš„ Toast æç¤º
  function showToast(msg) {
    const t = $('toast');
    t.textContent = msg;
    t.style.opacity = '1';
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (t._timeout) clearTimeout(t._timeout);
    t._timeout = setTimeout(() => { t.style.opacity = '0'; }, 2500);
  }

  // é€šç”¨å¼¹çª—å‡½æ•°
  function showModal(title, desc, actions = [], showInput = false) {
    $('modalTitle').textContent = title;
    $('modalDesc').textContent = desc;
    
    const inputArea = $('modalInputArea');
    const input = $('modalInput');
    inputArea.style.display = showInput ? 'block' : 'none';
    if(showInput) {
      input.value = '';
      // å»¶è¿Ÿèšç„¦ï¼Œé¿å… iOS é”®ç›˜é—®é¢˜
      setTimeout(() => input.focus(), 100);
    }

    const actionContainer = $('modalActions');
    actionContainer.innerHTML = '';
    
    if (actions.length === 0) {
      actions = [{ text: 'ç¡®å®š', class: 'btn-primary', onClick: () => closeModal() }];
    }
    
    actions.forEach(act => {
      const btn = document.createElement('button');
      btn.className = `btn ${act.class || 'btn-outline'}`;
      btn.textContent = act.text;
      btn.onclick = () => {
        const val = showInput ? input.value : null;
        act.onClick(val);
        if (!act.keepOpen) closeModal();
      };
      actionContainer.appendChild(btn);
    });
    
    $('commonModal').classList.add('active');
    // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    $('commonModal').classList.remove('active');
    document.body.style.overflow = '';
  }

  function switchView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    $(id).classList.add('active');
    if(id === 'gameView') {
      // å»¶è¿Ÿè°ƒæ•´æ£‹ç›˜å¤§å°ï¼Œç¡®ä¿å¸ƒå±€å®Œæˆ
      requestAnimationFrame(() => {
        setTimeout(resizeBoard, 50);
      });
    }
  }

  // ==================== 1. çŠ¶æ€ç®¡ç† ====================
  const state = {
    socket: null,
    nickname: '',
    currentRoom: null,
    myRole: null, 
    board: null, 
    lastMove: null,
    hoverPos: null,
    boardSize: 15,
    cellSize: 0,
    padding: 0,
    turnTimer: null,
    timeRemaining: 30,
    pendingRoomId: null,
    lastTouchTime: 0, // é˜²æ­¢åŒå‡»ç¼©æ”¾
    isPlacingStone: false // é˜²æ­¢é‡å¤è½å­
  };

  // ==================== 2. Canvas æ¸²æŸ“ (è·¨è®¾å¤‡ä¼˜åŒ–) ====================
  function resizeBoard() {
    const container = canvas.parentElement;
    if (!container) return;
    
    const containerWidth = container.clientWidth;
    const containerHeight = container.clientHeight || window.innerHeight * 0.5;
    
    // æ ¹æ®è®¾å¤‡å’Œæ–¹å‘è®¡ç®—æœ€ä½³å°ºå¯¸
    const isLandscape = window.innerWidth > window.innerHeight;
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth <= 1024 && window.innerWidth > 768;
    
    let maxSize;
    if (isMobile) {
      maxSize = Math.min(containerWidth - 20, window.innerHeight * 0.45);
    } else if (isTablet) {
      maxSize = Math.min(containerWidth - 20, window.innerHeight * 0.55);
    } else if (isLandscape && window.innerHeight < 600) {
      maxSize = Math.min(containerWidth, window.innerHeight * 0.75);
    } else {
      maxSize = Math.min(containerWidth, window.innerHeight * 0.65);
    }
    
    const size = Math.max(200, Math.floor(maxSize));
    
    // é«˜ DPI æ”¯æŒ
    const dpr = Math.min(window.devicePixelRatio || 1, 3); // é™åˆ¶æœ€å¤§ DPR
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = size + 'px';
    canvas.style.height = size + 'px';
    
    // é‡ç½®å˜æ¢
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);
    
    state.padding = size * 0.06;
    state.cellSize = (size - state.padding * 2) / (state.boardSize - 1);
    
    renderBoard();
  }

  function renderBoard() {
    const width = parseFloat(canvas.style.width) || 300;
    const height = parseFloat(canvas.style.height) || 300;

    // æ¸…é™¤ç”»å¸ƒ
    ctx.clearRect(0, 0, width, height);

    // æœ¨çº¹èƒŒæ™¯
    const grd = ctx.createLinearGradient(0, 0, width, height);
    grd.addColorStop(0, "#eabb7b");
    grd.addColorStop(1, "#cd9b4d");
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, width, height);

    // ç½‘æ ¼çº¿
    ctx.beginPath();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#5d4037";
    for (let i = 0; i < state.boardSize; i++) {
      const pos = state.padding + i * state.cellSize;
      ctx.moveTo(state.padding, pos); 
      ctx.lineTo(width - state.padding, pos);
      ctx.moveTo(pos, state.padding); 
      ctx.lineTo(pos, height - state.padding);
    }
    ctx.stroke();

    // æ˜Ÿä½
    const starPoints = [3, 7, 11];
    starPoints.forEach(r => starPoints.forEach(c => {
      ctx.beginPath();
      ctx.arc(state.padding + c * state.cellSize, state.padding + r * state.cellSize, Math.max(2, state.cellSize * 0.1), 0, Math.PI * 2);
      ctx.fillStyle = "#5d4037";
      ctx.fill();
    }));

    // æ£‹å­
    if (state.board) {
      for (let x = 0; x < state.boardSize; x++) {
        for (let y = 0; y < state.boardSize; y++) {
          if (state.board[x][y] !== 0) drawStone(x, y, state.board[x][y]);
        }
      }
    }

    // é¢„é€‰æ¡†
    if (state.hoverPos && state.myRole !== 'watcher' && state.currentRoom?.status === 'playing') {
       const isMyTurn = (state.myRole === 'black' && state.currentRoom.currentTurn === 1) || 
                        (state.myRole === 'white' && state.currentRoom.currentTurn === 2);
       if (isMyTurn && state.board && state.board[state.hoverPos.x] && state.board[state.hoverPos.x][state.hoverPos.y] === 0) {
         drawSelection(state.hoverPos.x, state.hoverPos.y);
       }
    }

    // æœ€åä¸€æ‰‹æ ‡è®°
    if (state.lastMove) {
      const cx = state.padding + state.lastMove.x * state.cellSize;
      const cy = state.padding + state.lastMove.y * state.cellSize;
      ctx.fillStyle = "#c0392b";
      ctx.beginPath(); 
      ctx.arc(cx, cy, Math.max(2, state.cellSize * 0.1), 0, Math.PI * 2); 
      ctx.fill();
      ctx.strokeStyle = "rgba(192, 57, 43, 0.8)";
      ctx.lineWidth = 2;
      ctx.beginPath(); 
      ctx.arc(cx, cy, state.cellSize * 0.3, 0, Math.PI * 2); 
      ctx.stroke();
    }
  }

  function drawStone(x, y, color) {
    const cx = state.padding + x * state.cellSize;
    const cy = state.padding + y * state.cellSize;
    const r = state.cellSize * 0.45;
    
    ctx.save();
    // é˜´å½±
    ctx.shadowColor = "rgba(0,0,0,0.4)"; 
    ctx.shadowBlur = Math.max(2, r * 0.2); 
    ctx.shadowOffsetX = 2; 
    ctx.shadowOffsetY = 2;
    ctx.beginPath(); 
    ctx.arc(cx, cy, r, 0, Math.PI * 2); 
    ctx.fillStyle = color === 1 ? "#000" : "#fff"; 
    ctx.fill();
    ctx.shadowColor = "transparent";

    // 3D è´¨æ„Ÿæ¸å˜
    const grad = ctx.createRadialGradient(cx - r * 0.3, cy - r * 0.3, r * 0.1, cx, cy, r);
    if (color === 1) {
      grad.addColorStop(0, "#666"); 
      grad.addColorStop(0.3, "#222"); 
      grad.addColorStop(1, "#000");
    } else {
      grad.addColorStop(0, "#fff"); 
      grad.addColorStop(0.3, "#f0f0f0"); 
      grad.addColorStop(1, "#ccc");
    }
    ctx.fillStyle = grad;
    ctx.beginPath(); 
    ctx.arc(cx, cy, r, 0, Math.PI * 2); 
    ctx.fill();
    ctx.restore();
  }

  function drawSelection(x, y) {
    const cx = state.padding + x * state.cellSize;
    const cy = state.padding + y * state.cellSize;
    const size = state.cellSize * 0.4;
    const corner = Math.max(3, size * 0.3);
    
    ctx.strokeStyle = "rgba(197, 160, 89, 0.8)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    // å››ä¸ªè§’
    ctx.moveTo(cx - size, cy - size + corner); ctx.lineTo(cx - size, cy - size); ctx.lineTo(cx - size + corner, cy - size);
    ctx.moveTo(cx + size - corner, cy - size); ctx.lineTo(cx + size, cy - size); ctx.lineTo(cx + size, cy - size + corner);
    ctx.moveTo(cx + size, cy + size - corner); ctx.lineTo(cx + size, cy + size); ctx.lineTo(cx + size - corner, cy + size);
    ctx.moveTo(cx - size + corner, cy + size); ctx.lineTo(cx - size, cy + size); ctx.lineTo(cx - size, cy + size - corner);
    ctx.stroke();
  }

  // ==================== 3. Socket.IO é€»è¾‘äº¤äº’ ====================
  function initSocket() {
    // Socket.IO è¿æ¥é…ç½®
    state.socket = io({
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000,
      timeout: 20000
    });

    state.socket.on('connect', () => {
      const saved = localStorage.getItem('gomoku_nick');
      if (saved) $('nicknameInput').value = saved;
      showToast('å·²è¿æ¥æœåŠ¡å™¨');
    });

    state.socket.on('disconnect', () => {
      showToast('è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...');
    });

    state.socket.on('reconnect', () => {
      showToast('é‡æ–°è¿æ¥æˆåŠŸ');
      // å¦‚æœåœ¨æˆ¿é—´ä¸­ï¼Œå°è¯•é‡æ–°åŠ å…¥
      if (state.currentRoom && state.nickname) {
        state.socket.emit('rejoin-room', { 
          roomId: state.currentRoom.id, 
          nickname: state.nickname 
        });
      }
    });
    
    // 1. åœ¨çº¿äººæ•°
    state.socket.on('online-count', ({count}) => {
      $('onlineCount').textContent = count;
    });
    
    // 2. æˆ¿é—´åˆ—è¡¨æ›´æ–°
    state.socket.on('room-list', (rooms) => {
      const grid = $('roomListGrid');
      if (!rooms || rooms.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--text-muted); padding:2rem;">æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
        return;
      }
      grid.innerHTML = rooms.map(room => {
        const isFull = room.blackPlayer && room.whitePlayer;
        const canJoin = room.status === 'waiting' && !isFull;
        // è½¬ä¹‰ HTML é˜²æ­¢ XSS
        const safeName = escapeHtml(room.name);
        const safeBlack = escapeHtml(room.blackPlayer || 'ç©ºä½');
        const safeWhite = escapeHtml(room.whitePlayer || 'ç©ºä½');
        return `
        <div class="glass-card room-card" tabindex="0" role="button" aria-label="æˆ¿é—´ ${safeName}">
          <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
            <span style="font-weight:bold; color:var(--text-main); font-family:'Cinzel'; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60%;">${safeName}</span>
            <span class="room-status ${room.status === 'playing' ? 'status-playing' : 'status-waiting'}">${room.status}</span>
          </div>
          <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.8rem;">
            <div>âš« ${safeBlack}</div>
            <div>âšª ${safeWhite}</div>
            <div style="margin-top:0.3rem;">ğŸ‘ è§‚æˆ˜: ${room.watcherCount || 0}</div>
          </div>
          <div style="display:flex; gap:0.5rem;">
            ${canJoin ? `<button class="btn btn-primary" style="flex:1;" onclick="joinRoom('${room.id}')">åŠ å…¥</button>` : ''}
            <button class="btn btn-outline" style="flex:1;" onclick="watchRoom('${room.id}')">è§‚æˆ˜</button>
          </div>
        </div>
      `}).join('');
    });

    // 3. åŠ å…¥æˆ¿é—´æˆåŠŸ
    state.socket.on('room-joined', ({ room, role }) => {
      state.currentRoom = room;
      state.myRole = role;
      state.board = room.board;
      state.lastMove = room.history && room.history.length ? room.history[room.history.length - 1] : null;
      
      switchView('gameView');
      updateGameUI();
    });

    // 4. æˆ¿é—´çŠ¶æ€æ›´æ–°
    state.socket.on('room-updated', (room) => {
      state.currentRoom = room;
      state.board = room.board;
      state.lastMove = room.history && room.history.length ? room.history[room.history.length - 1] : null;
      state.isPlacingStone = false;
      updateGameUI();
      renderBoard();
    });

    // 5. è½å­äº‹ä»¶
    state.socket.on('stone-placed', ({ x, y, color }) => {
      if(state.board) {
        state.board[x][y] = color;
        state.lastMove = {x, y};
        state.isPlacingStone = false;
        renderBoard();
      }
    });

    // 6. æ¸¸æˆç»“æŸ
    state.socket.on('game-over', ({ winner, surrender }) => {
      stopClientTimer();
      state.isPlacingStone = false;
      const text = winner === 1 ? 'é»‘æ£‹è·èƒœ' : 'ç™½æ£‹è·èƒœ';
      const desc = surrender ? 'å¯¹æ–¹å·²è®¤è¾“' : 'äº”æ˜Ÿè¿ç ï¼';
      
      showModal(text, desc, [
        { text: 'å†æ¥ä¸€å±€', class: 'btn-primary', onClick: () => state.socket.emit('request-rematch', { roomId: state.currentRoom.id }), keepOpen: true },
        { text: 'ç¦»å¼€', class: 'btn-danger', onClick: () => leaveRoom() }
      ]);
    });

    // 7. èŠå¤©æ¶ˆæ¯
    state.socket.on('chat-received', ({ nickname, message }) => {
      const box = $('chatMessages');
      const safeNick = escapeHtml(nickname);
      const safeMsg = escapeHtml(message);
      box.innerHTML += `<div class="msg"><b>${safeNick}:</b>${safeMsg}</div>`;
      box.scrollTop = box.scrollHeight;
    });

    // 8. æ‚”æ£‹è¯·æ±‚
    state.socket.on('undo-requested', () => {
      showModal('æ‚”æ£‹è¯·æ±‚', 'å¯¹æ–¹æƒ³è¦æ‚”æ£‹ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ', [
        { text: 'åŒæ„', class: 'btn-primary', onClick: () => state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: true }) },
        { text: 'æ‹’ç»', class: 'btn-danger', onClick: () => state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: false }) }
      ]);
    });

    // 9. æ¢æ–¹è¯·æ±‚
    state.socket.on('swap-requested', () => {
       showModal('æ¢æ–¹è¯·æ±‚', 'å¯¹æ–¹è¯·æ±‚äº¤æ¢æ‰§æ£‹é¢œè‰²ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ', [
        { text: 'åŒæ„', class: 'btn-primary', onClick: () => state.socket.emit('respond-swap', { roomId: state.currentRoom.id, accept: true }) },
        { text: 'æ‹’ç»', class: 'btn-danger', onClick: () => state.socket.emit('respond-swap', { roomId: state.currentRoom.id, accept: false }) }
      ]);
    });

    // 10. å¤„ç†ç»“æœåé¦ˆ
    state.socket.on('undo-result', ({accepted}) => showToast(accepted ? 'æ‚”æ£‹æˆåŠŸ' : 'å¯¹æ–¹æ‹’ç»äº†æ‚”æ£‹'));
    state.socket.on('swap-result', ({accepted}) => {
      if(accepted) {
        state.myRole = state.myRole === 'black' ? 'white' : 'black';
        showToast('æ¢æ–¹æˆåŠŸ');
      } else {
        showToast('å¯¹æ–¹æ‹’ç»æ¢æ–¹');
      }
    });
    
    // 11. å†æ¥ä¸€å±€
    state.socket.on('rematch-start', ({swapped}) => {
      closeModal();
      showToast('æ–°å¯¹å±€å¼€å§‹ï¼');
      if(swapped) state.myRole = state.myRole === 'black' ? 'white' : 'black';
    });

    // 12. è®¡æ—¶å™¨åŒæ­¥
    state.socket.on('turn-timer-start', ({ timeLimit, currentTurn }) => {
      startClientTimer(timeLimit, currentTurn);
    });

    // é”™è¯¯å¤„ç†
    state.socket.on('error', ({message}) => showToast(message || 'å‘ç”Ÿé”™è¯¯'));
    state.socket.on('room-closed', () => { showToast('æˆ¿é—´å·²è§£æ•£'); leaveRoom(); });
  }

  // HTML è½¬ä¹‰å‡½æ•°
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ==================== 4. è¾…åŠ©é€»è¾‘ ====================
  function updateGameUI() {
    const r = state.currentRoom;
    if (!r) return;
    
    $('roomIdDisplay').textContent = r.id || '-';
    $('roleDisplay').textContent = state.myRole === 'watcher' ? 'è§‚æˆ˜è€…' : (state.myRole === 'black' ? 'æ‰§é»‘' : 'æ‰§ç™½');

    // æ›´æ–°ç©å®¶çŠ¶æ€
    updatePlayer('black', r.players?.black, r.currentTurn === 1 && r.status === 'playing');
    updatePlayer('white', r.players?.white, r.currentTurn === 2 && r.status === 'playing');
    
    // æ›´æ–°å†å²æ¶ˆæ¯
    if(r.chat && Array.isArray(r.chat)) {
      $('chatMessages').innerHTML = r.chat.map(m => {
        const safeNick = escapeHtml(m.nickname);
        const safeMsg = escapeHtml(m.message);
        return `<div class="msg"><b>${safeNick}:</b>${safeMsg}</div>`;
      }).join('');
      $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
    }
  }

  function updatePlayer(color, player, isTurn) {
    const el = $(`${color}PlayerPanel`);
    const nameEl = $(`${color}Name`);
    const timerEl = $(`${color}Timer`);
    
    if (!el || !nameEl || !timerEl) return;
    
    if (player) {
      nameEl.textContent = player.nickname || '-';
      el.style.opacity = '1';
    } else {
      nameEl.textContent = 'ç­‰å¾…åŠ å…¥...';
      el.style.opacity = '0.5';
    }

    const avatar = el.querySelector('.avatar');
    if (isTurn) {
      el.classList.add('active');
      if (avatar) avatar.classList.add('thinking');
    } else {
      el.classList.remove('active');
      if (avatar) avatar.classList.remove('thinking');
      timerEl.textContent = '';
    }
  }

  // å®¢æˆ·ç«¯å€’è®¡æ—¶é€»è¾‘
  function startClientTimer(timeLimit, currentTurn) {
    stopClientTimer();
    state.timeRemaining = Math.floor(timeLimit / 1000);
    
    const targetId = currentTurn === 1 ? 'blackTimer' : 'whiteTimer';
    const timerEl = $(targetId);
    if (!timerEl) return;
    
    timerEl.textContent = state.timeRemaining + 's';
    
    state.turnTimer = setInterval(() => {
      state.timeRemaining--;
      if(state.timeRemaining >= 0) {
        timerEl.textContent = state.timeRemaining + 's';
      }
      if (state.timeRemaining <= 0) stopClientTimer();
    }, 1000);
  }

  function stopClientTimer() {
    if (state.turnTimer) {
      clearInterval(state.turnTimer);
      state.turnTimer = null;
    }
    const blackTimer = $('blackTimer');
    const whiteTimer = $('whiteTimer');
    if (blackTimer) blackTimer.textContent = '';
    if (whiteTimer) whiteTimer.textContent = '';
  }

  function joinLobby() {
    const nick = $('nicknameInput').value.trim();
    if (!nick) return showToast('è¯·è¾“å…¥æ˜µç§°');
    if (nick.length > 12) return showToast('æ˜µç§°æœ€å¤š12ä¸ªå­—ç¬¦');
    
    state.nickname = nick;
    try {
      localStorage.setItem('gomoku_nick', nick);
    } catch(e) {
      // localStorage å¯èƒ½ä¸å¯ç”¨
    }
    state.socket.emit('join-lobby', { nickname: nick });
    
    $('loginPanel').style.display = 'none';
    $('lobbyContent').style.display = 'block';

    // å¦‚æœé“¾æ¥é‡Œå¸¦æœ‰æˆ¿é—´å·ï¼Œç™»å½•åè‡ªåŠ¨åŠ å…¥
    if (state.pendingRoomId) {
      showToast('æ­£åœ¨é€šè¿‡é‚€è¯·åŠ å…¥æˆ¿é—´...');
      joinRoom(state.pendingRoomId);
      state.pendingRoomId = null;
      try {
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch(e) {}
    }
  }

  window.joinRoom = (id) => {
    if (!id) return;
    state.socket.emit('join-room', { roomId: id, asWatcher: false });
  };
  
  window.watchRoom = (id) => {
    if (!id) return;
    state.socket.emit('join-room', { roomId: id, asWatcher: true });
  };
  
  function leaveRoom() {
    if(state.currentRoom) {
      state.socket.emit('leave-room', { roomId: state.currentRoom.id });
    }
    state.currentRoom = null;
    state.board = null;
    state.lastMove = null;
    state.isPlacingStone = false;
    stopClientTimer();
    switchView('lobbyView');
  }

  // ==================== 5. äº‹ä»¶ç»‘å®š ====================
  $('joinLobbyBtn').onclick = joinLobby;
  $('nicknameInput').onkeypress = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      joinLobby();
    }
  };

  // å¼¹çª—åˆ›å»ºæˆ¿é—´é€»è¾‘
  $('createRoomBtn').onclick = () => {
    showModal('åˆ›å»ºæˆ¿é—´', 'è¯·è¾“å…¥æˆ¿é—´åç§°', [
        { text: 'å–æ¶ˆ', class: 'btn-outline', onClick: () => {} },
        { text: 'åˆ›å»º', class: 'btn-primary', onClick: (val) => {
            const roomName = (val || '').trim() || `${state.nickname}çš„æˆ¿é—´`;
            state.socket.emit('create-room', { name: roomName });
        }}
    ], true);
  };

  $('quickMatchBtn').onclick = () => state.socket.emit('quick-match');
  $('refreshBtn').onclick = () => state.socket.emit('refresh-rooms');
  
  // èŠå¤©å‘é€
  const sendMsg = () => {
    const input = $('chatInput');
    const val = input.value.trim();
    if(val && state.currentRoom) {
      state.socket.emit('chat-message', { roomId: state.currentRoom.id, message: val });
      input.value = '';
    }
  };
  $('sendChatBtn').onclick = sendMsg;
  $('chatInput').onkeypress = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMsg();
    }
  };
  
  // æ¸¸æˆæ§åˆ¶
  $('undoBtn').onclick = () => {
    if (state.currentRoom) {
      state.socket.emit('request-undo', { roomId: state.currentRoom.id });
    }
  };
  
  $('swapBtn').onclick = () => {
    if (state.currentRoom) {
      state.socket.emit('request-swap', { roomId: state.currentRoom.id });
    }
  };
  
  $('surrenderBtn').onclick = () => {
    if (state.currentRoom && confirm('ç¡®å®šè®¤è¾“?')) {
      state.socket.emit('surrender', { roomId: state.currentRoom.id });
    }
  };
  
  $('leaveRoomBtn').onclick = () => {
    if (confirm('ç¡®å®šç¦»å¼€?')) {
      leaveRoom();
    }
  };
  
  // é‚€è¯·é“¾æ¥ - å…¼å®¹æ€§å¤„ç†
  $('inviteBtn').onclick = () => {
    if (!state.currentRoom) return;
    
    const url = window.location.href.split('?')[0] + '?room=' + state.currentRoom.id;
    
    // å°è¯•ä½¿ç”¨ Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url)
        .then(() => showToast('é‚€è¯·é“¾æ¥å·²å¤åˆ¶ï¼'))
        .catch(() => fallbackCopy(url));
    } else {
      fallbackCopy(url);
    }
  };
  
  // å›é€€å¤åˆ¶æ–¹æ³•
  function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    textarea.style.top = '0';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    
    try {
      const successful = document.execCommand('copy');
      showToast(successful ? 'é‚€è¯·é“¾æ¥å·²å¤åˆ¶ï¼' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    } catch (err) {
      showToast('å¤åˆ¶å¤±è´¥');
    }
    
    document.body.removeChild(textarea);
  }

  // ==================== 6. Canvas è¾“å…¥å¤„ç† (è·¨è®¾å¤‡å…¼å®¹) ====================
  
  // è·å–æ£‹ç›˜åæ ‡
  function getBoardPosition(clientX, clientY) {
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.min(window.devicePixelRatio || 1, 3);
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    const x = (clientX - rect.left) * scaleX;
    const y = (clientY - rect.top) * scaleY;
    
    const c = Math.round((x / dpr - state.padding) / state.cellSize);
    const r = Math.round((y / dpr - state.padding) / state.cellSize);
    
    if (c >= 0 && c < state.boardSize && r >= 0 && r < state.boardSize) {
      return { x: c, y: r };
    }
    return null;
  }

  // å¤„ç†è¾“å…¥
  function handleInput(clientX, clientY, isClick) {
    if (!state.currentRoom || state.currentRoom.status !== 'playing') return;
    if (!state.board) return;
    
    const pos = getBoardPosition(clientX, clientY);
    if (!pos) return;
    
    // æ›´æ–°æ‚¬åœä½ç½®
    if (!state.hoverPos || state.hoverPos.x !== pos.x || state.hoverPos.y !== pos.y) {
      state.hoverPos = pos;
      renderBoard();
    }
    
    // å¤„ç†ç‚¹å‡»è½å­
    if (isClick && state.myRole !== 'watcher' && !state.isPlacingStone) {
      const isMyTurn = (state.myRole === 'black' && state.currentRoom.currentTurn === 1) || 
                       (state.myRole === 'white' && state.currentRoom.currentTurn === 2);
      
      if (isMyTurn && state.board[pos.x] && state.board[pos.x][pos.y] === 0) {
        state.isPlacingStone = true;
        state.socket.emit('place-stone', { 
          roomId: state.currentRoom.id, 
          x: pos.x, 
          y: pos.y 
        });
        
        // è¶…æ—¶é‡ç½®
        setTimeout(() => {
          state.isPlacingStone = false;
        }, 3000);
      }
    }
  }

  // é¼ æ ‡äº‹ä»¶
  canvas.addEventListener('mousemove', (e) => {
    handleInput(e.clientX, e.clientY, false);
  });
  
  canvas.addEventListener('mousedown', (e) => {
    e.preventDefault();
    handleInput(e.clientX, e.clientY, true);
  });
  
  canvas.addEventListener('mouseleave', () => {
    state.hoverPos = null;
    renderBoard();
  });

  // è§¦æ‘¸äº‹ä»¶ - ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ
  let touchStartPos = null;
  let touchMoved = false;

  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    touchStartPos = { x: touch.clientX, y: touch.clientY };
    touchMoved = false;
    
    // æ˜¾ç¤ºé¢„è§ˆ
    handleInput(touch.clientX, touch.clientY, false);
  }, { passive: false });

  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    
    // æ£€æµ‹æ˜¯å¦ç§»åŠ¨äº†
    if (touchStartPos) {
      const dx = Math.abs(touch.clientX - touchStartPos.x);
      const dy = Math.abs(touch.clientY - touchStartPos.y);
      if (dx > 10 || dy > 10) {
        touchMoved = true;
      }
    }
    
    handleInput(touch.clientX, touch.clientY, false);
  }, { passive: false });

  canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    
    // åªæœ‰åœ¨æ²¡æœ‰ç§»åŠ¨çš„æƒ…å†µä¸‹æ‰è½å­
    if (!touchMoved && state.hoverPos) {
      const pos = state.hoverPos;
      handleInput(
        state.padding + pos.x * state.cellSize,
        state.padding + pos.y * state.cellSize,
        true
      );
      
      // ç›´æ¥ä½¿ç”¨ä¿å­˜çš„ä½ç½®è½å­
      if (state.currentRoom && state.currentRoom.status === 'playing' && 
          state.myRole !== 'watcher' && !state.isPlacingStone) {
        const isMyTurn = (state.myRole === 'black' && state.currentRoom.currentTurn === 1) || 
                         (state.myRole === 'white' && state.currentRoom.currentTurn === 2);
        
        if (isMyTurn && state.board && state.board[pos.x] && state.board[pos.x][pos.y] === 0) {
          state.isPlacingStone = true;
          state.socket.emit('place-stone', { 
            roomId: state.currentRoom.id, 
            x: pos.x, 
            y: pos.y 
          });
          
          setTimeout(() => {
            state.isPlacingStone = false;
          }, 3000);
        }
      }
    }
    
    // æ¸…é™¤æ‚¬åœçŠ¶æ€
    setTimeout(() => {
      state.hoverPos = null;
      renderBoard();
    }, 100);
    
    touchStartPos = null;
    touchMoved = false;
  }, { passive: false });

  canvas.addEventListener('touchcancel', () => {
    state.hoverPos = null;
    touchStartPos = null;
    touchMoved = false;
    renderBoard();
  });

  // ==================== 7. åˆå§‹åŒ–å’Œäº‹ä»¶ç›‘å¬ ====================
  
  // çª—å£å¤§å°å˜åŒ–
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(resizeBoard, 100);
  });

  // å±å¹•æ–¹å‘å˜åŒ–
  window.addEventListener('orientationchange', () => {
    setTimeout(resizeBoard, 200);
  });

  // å¯è§æ€§å˜åŒ– (æ ‡ç­¾é¡µåˆ‡æ¢)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && state.currentRoom) {
      // é‡æ–°æ¸²æŸ“æ£‹ç›˜
      renderBoard();
    }
  });

  // é˜²æ­¢ iOS Safari åŒå‡»ç¼©æ”¾
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - state.lastTouchTime < 300) {
      e.preventDefault();
    }
    state.lastTouchTime = now;
  }, { passive: false });

  // é˜²æ­¢é¡µé¢æ»šåŠ¨ (åœ¨æ¸¸æˆè§†å›¾ä¸­)
  document.addEventListener('touchmove', (e) => {
    if ($('gameView').classList.contains('active')) {
      const target = e.target;
      // å…è®¸èŠå¤©æ¡†æ»šåŠ¨
      if (target.closest('.chat-box') || target.closest('.view')) {
        return;
      }
      e.preventDefault();
    }
  }, { passive: false });

  // é”®ç›˜äº‹ä»¶ (æ— éšœç¢æ”¯æŒ)
  document.addEventListener('keydown', (e) => {
    // ESC å…³é—­å¼¹çª—
    if (e.key === 'Escape' && $('commonModal').classList.contains('active')) {
      closeModal();
    }
  });

  // åˆå§‹åŒ– Socket
  initSocket();
  
  // å¤„ç† URL é‚€è¯·å‚æ•°
  try {
    const params = new URLSearchParams(window.location.search);
    const inviteRoomId = params.get('room');
    if (inviteRoomId) {
      state.pendingRoomId = inviteRoomId;
      showToast('æ£€æµ‹åˆ°é‚€è¯·ï¼Œè¾“å…¥æ˜µç§°åè‡ªåŠ¨åŠ å…¥');
    }
  } catch(e) {
    // URL è§£æå¤±è´¥
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      // å°è¯•æ¢å¤æ˜µç§°
      try {
        const saved = localStorage.getItem('gomoku_nick');
        if (saved) $('nicknameInput').value = saved;
      } catch(e) {}
    });
  } else {
    try {
      const saved = localStorage.getItem('gomoku_nick');
      if (saved) $('nicknameInput').value = saved;
    } catch(e) {}
  }

  // å¤„ç† iOS è™šæ‹Ÿé”®ç›˜
  if (isIOS) {
    const inputs = document.querySelectorAll('input[type="text"]');
    inputs.forEach(input => {
      input.addEventListener('focus', () => {
        // æ»šåŠ¨åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    });
  }

  // å¤„ç† Android è¿”å›é”®
  if (isAndroid) {
    window.addEventListener('popstate', (e) => {
      if ($('commonModal').classList.contains('active')) {
        e.preventDefault();
        closeModal();
        history.pushState(null, '', window.location.href);
      } else if ($('gameView').classList.contains('active')) {
        e.preventDefault();
        if (confirm('ç¡®å®šç¦»å¼€æ¸¸æˆ?')) {
          leaveRoom();
        } else {
          history.pushState(null, '', window.location.href);
        }
      }
    });
    history.pushState(null, '', window.location.href);
  }

  // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ requestAnimationFrame è¿›è¡Œæ¸²æŸ“
  let renderScheduled = false;
  const originalRenderBoard = renderBoard;
  renderBoard = function() {
    if (!renderScheduled) {
      renderScheduled = true;
      requestAnimationFrame(() => {
        originalRenderBoard();
        renderScheduled = false;
      });
    }
  };

  console.log('ğŸ® äº‘å¼ˆ ZEN GOMOKU å·²åŠ è½½');
  console.log('ğŸ“± è®¾å¤‡ä¿¡æ¯:', {
    isTouchDevice,
    isIOS,
    isAndroid,
    isSafari,
    screenWidth: window.innerWidth,
    screenHeight: window.innerHeight,
    devicePixelRatio: window.devicePixelRatio
  });

</script>
</body>
</html>
