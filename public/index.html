<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº”å­æ£‹åœ¨çº¿å¯¹æˆ˜ - Gomoku Online</title>
  <style>
    /* CSS Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #8B4513;
      --primary-light: #D2691E;
      --bg: #FDF5E6;
      --card-bg: #FFFAF0;
      --text: #333;
      --text-light: #666;
      --border: #DEB887;
      --success: #228B22;
      --danger: #DC143C;
      --black-stone: #1a1a1a;
      --white-stone: #f5f5f5;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .header h1 { font-size: 1.5rem; }
    .online-count { font-size: 0.9rem; opacity: 0.9; margin-top: 0.3rem; }
    
    /* Container */
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    
    /* Views */
    .view { display: none; }
    .view.active { display: block; }
    
    /* Nickname Section */
    .nickname-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .nickname-section h2 { margin-bottom: 1rem; color: var(--primary); }
    .nickname-input {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .nickname-input input {
      padding: 0.8rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      width: 200px;
    }
    .nickname-input input:focus { outline: none; border-color: var(--primary); }
    
    /* Buttons */
    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { opacity: 0.9; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: white; }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
    
    /* Lobby Actions */
    .lobby-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    /* Room List */
    .room-list {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .room-list h3 { margin-bottom: 1rem; color: var(--primary); }
    .room-table { width: 100%; border-collapse: collapse; }
    .room-table th, .room-table td {
      padding: 0.8rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .room-table th { background: var(--bg); font-weight: 600; }
    .room-table tr:hover { background: var(--bg); }
    .status-waiting { color: var(--success); }
    .status-playing { color: var(--primary); }
    .status-ended { color: var(--text-light); }
    .empty-list { text-align: center; padding: 2rem; color: var(--text-light); }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
    }
    .modal h3 { margin-bottom: 1rem; color: var(--primary); }
    .modal input {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    
    /* Game View */
    .game-container {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      align-items: start;
    }
    @media (max-width: 900px) {
      .game-container {
        grid-template-columns: 1fr;
        justify-items: center;
      }
    }
    
    /* Board */
    .board-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #board { display: block; cursor: pointer; }
    
    /* Side Panels */
    .side-panel {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-width: 200px;
    }
    .panel-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }
    
    /* Player Info */
    .player-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .player-info.active { background: #E8F5E9; border: 2px solid var(--success); }
    .player-info.black .stone-icon { background: var(--black-stone); }
    .player-info.white .stone-icon {
      background: var(--white-stone);
      border: 2px solid #ccc;
    }
    .stone-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .player-name { font-weight: 500; }
    .waiting-text { color: var(--text-light); font-style: italic; }
    
    /* Watchers */
    .watcher-list {
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    /* Game Actions */
    .game-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    /* Chat */
    .chat-container {
      margin-top: 1rem;
    }
    .chat-messages {
      height: 150px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
    }
    .chat-message {
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
    }
    .chat-time { color: var(--text-light); font-size: 0.8rem; }
    .chat-nick { color: var(--primary); font-weight: 500; }
    .chat-input {
      display: flex;
      gap: 0.5rem;
    }
    .chat-input input {
      flex: 1;
      padding: 0.5rem;
      border: 2px solid var(--border);
      border-radius: 8px;
    }
    
    /* Result Modal */
    .result-modal {
      text-align: center;
    }
    .result-modal h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .winner-black { color: var(--black-stone); }
    .winner-white { color: var(--primary); }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      z-index: 2000;
      display: none;
    }
    .toast.show { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ® äº”å­æ£‹åœ¨çº¿å¯¹æˆ˜</h1>
    <div class="online-count">åœ¨çº¿äººæ•°: <span id="onlineCount">0</span></div>
  </div>

  <div class="container">
    <!-- å¤§å…è§†å›¾ -->
    <div id="lobbyView" class="view active">
      <div class="nickname-section">
        <h2>æ¬¢è¿æ¥åˆ°äº”å­æ£‹</h2>
        <div class="nickname-input">
          <input type="text" id="nicknameInput" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="20">
          <button class="btn btn-primary" id="joinLobbyBtn">è¿›å…¥å¤§å…</button>
        </div>
      </div>

      <div id="lobbyContent" style="display: none;">
        <div class="lobby-actions">
          <button class="btn btn-success" id="createRoomBtn">åˆ›å»ºæˆ¿é—´</button>
          <button class="btn btn-primary" id="quickMatchBtn">å¿«é€ŸåŒ¹é…</button>
          <button class="btn btn-outline" id="refreshBtn">åˆ·æ–°åˆ—è¡¨</button>
        </div>

        <div class="room-list">
          <h3>æˆ¿é—´åˆ—è¡¨</h3>
          <table class="room-table">
            <thead>
              <tr>
                <th>æˆ¿é—´ID</th>
                <th>æˆ¿é—´å</th>
                <th>é»‘æ£‹</th>
                <th>ç™½æ£‹</th>
                <th>çŠ¶æ€</th>
                <th>è§‚æˆ˜</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="roomListBody">
              <tr><td colspan="7" class="empty-list">æš‚æ— æˆ¿é—´</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ¸¸æˆè§†å›¾ -->
    <div id="gameView" class="view">
      <div class="game-container">
        <div class="side-panel">
          <div class="panel-title">æˆ¿é—´ä¿¡æ¯</div>
          <div>æˆ¿é—´: <span id="roomName">-</span></div>
          <div>ID: <span id="roomId">-</span></div>
          
          <div class="panel-title" style="margin-top: 1rem;">ç©å®¶</div>
          <div id="blackPlayer" class="player-info black">
            <div class="stone-icon"></div>
            <span class="player-name waiting-text">ç­‰å¾…åŠ å…¥...</span>
          </div>
          <div id="whitePlayer" class="player-info white">
            <div class="stone-icon"></div>
            <span class="player-name waiting-text">ç­‰å¾…åŠ å…¥...</span>
          </div>
          
          <div class="panel-title" style="margin-top: 1rem;">è§‚æˆ˜è€… (<span id="watcherCount">0</span>)</div>
          <div class="watcher-list" id="watcherList">-</div>
        </div>

        <div class="board-container">
          <canvas id="board" width="480" height="480"></canvas>
        </div>

        <div class="side-panel">
          <div class="panel-title">æ¸¸æˆæ“ä½œ</div>
          <div class="game-actions">
            <button class="btn btn-outline btn-sm" id="undoBtn">è¯·æ±‚æ‚”æ£‹</button>
            <button class="btn btn-danger btn-sm" id="surrenderBtn">è®¤è¾“</button>
            <button class="btn btn-outline btn-sm" id="leaveRoomBtn">é€€å‡ºæˆ¿é—´</button>
          </div>

          <div class="chat-container">
            <div class="panel-title">èŠå¤©</div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <input type="text" id="chatInput" placeholder="å‘é€æ¶ˆæ¯..." maxlength="200">
              <button class="btn btn-primary btn-sm" id="sendChatBtn">å‘é€</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»ºæˆ¿é—´å¼¹çª— -->
  <div class="modal-overlay" id="createRoomModal">
    <div class="modal">
      <h3>åˆ›å»ºæˆ¿é—´</h3>
      <input type="text" id="roomNameInput" placeholder="æˆ¿é—´åç§°" maxlength="30">
      <div class="modal-actions">
        <button class="btn btn-outline" id="cancelCreateBtn">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="confirmCreateBtn">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- ç»“æœå¼¹çª— -->
  <div class="modal-overlay" id="resultModal">
    <div class="modal result-modal">
      <h2 id="resultText">æ¸¸æˆç»“æŸ</h2>
      <p id="resultDetail"></p>
      <div class="modal-actions" style="justify-content: center; margin-top: 1rem;">
        <button class="btn btn-primary" id="closeResultBtn">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- æ‚”æ£‹è¯·æ±‚å¼¹çª— -->
  <div class="modal-overlay" id="undoRequestModal">
    <div class="modal">
      <h3>æ‚”æ£‹è¯·æ±‚</h3>
      <p><span id="undoRequester">å¯¹æ–¹</span> è¯·æ±‚æ‚”æ£‹</p>
      <div class="modal-actions">
        <button class="btn btn-outline" id="rejectUndoBtn">æ‹’ç»</button>
        <button class="btn btn-primary" id="acceptUndoBtn">åŒæ„</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    const state = {
      socket: null,
      nickname: '',
      currentRoom: null,
      myRole: null,
      board: null,
      lastMove: null,
      winningStones: null
    };

    // ==================== DOM å…ƒç´  ====================
    const $ = id => document.getElementById(id);
    const lobbyView = $('lobbyView');
    const gameView = $('gameView');
    const nicknameInput = $('nicknameInput');
    const lobbyContent = $('lobbyContent');
    const roomListBody = $('roomListBody');
    const onlineCount = $('onlineCount');
    const canvas = $('board');
    const ctx = canvas.getContext('2d');

    // ==================== å·¥å…·å‡½æ•° ====================
    function showToast(msg, duration = 2000) {
      const toast = $('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showView(view) {
      lobbyView.classList.remove('active');
      gameView.classList.remove('active');
      view.classList.add('active');
    }

    // ==================== æ£‹ç›˜æ¸²æŸ“ ====================
    const BOARD_SIZE = 15;
    const PADDING = 30;
    let CELL_SIZE = 30;

    function resizeBoard() {
      const maxSize = Math.min(window.innerWidth - 40, 500);
      const size = Math.max(300, maxSize);
      canvas.width = size;
      canvas.height = size;
      CELL_SIZE = (size - PADDING * 2) / (BOARD_SIZE - 1);
      renderBoard();
    }

    function renderBoard() {
      const width = canvas.width;
      const height = canvas.height;
      
      // æœ¨çº¹èƒŒæ™¯
      ctx.fillStyle = '#DEB887';
      ctx.fillRect(0, 0, width, height);
      
      // ç»˜åˆ¶ç½‘æ ¼
      ctx.strokeStyle = '#8B4513';
      ctx.lineWidth = 1;
      
      for (let i = 0; i < BOARD_SIZE; i++) {
        const pos = PADDING + i * CELL_SIZE;
        // æ¨ªçº¿
        ctx.beginPath();
        ctx.moveTo(PADDING, pos);
        ctx.lineTo(width - PADDING, pos);
        ctx.stroke();
        // ç«–çº¿
        ctx.beginPath();
        ctx.moveTo(pos, PADDING);
        ctx.lineTo(pos, height - PADDING);
        ctx.stroke();
      }
      
      // ç»˜åˆ¶æ˜Ÿä½
      const starPoints = [3, 7, 11];
      ctx.fillStyle = '#8B4513';
      for (const x of starPoints) {
        for (const y of starPoints) {
          ctx.beginPath();
          ctx.arc(PADDING + x * CELL_SIZE, PADDING + y * CELL_SIZE, 4, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      // ç»˜åˆ¶æ£‹å­
      if (state.board) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          for (let y = 0; y < BOARD_SIZE; y++) {
            if (state.board[x][y] !== 0) {
              drawStone(x, y, state.board[x][y]);
            }
          }
        }
      }
      
      // é«˜äº®æœ€åè½å­
      if (state.lastMove) {
        const { x, y } = state.lastMove;
        const px = PADDING + x * CELL_SIZE;
        const py = PADDING + y * CELL_SIZE;
        ctx.fillStyle = '#FF0000';
        ctx.beginPath();
        ctx.arc(px, py, 5, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // é«˜äº®è·èƒœæ£‹å­
      if (state.winningStones) {
        ctx.strokeStyle = '#FF0000';
        ctx.lineWidth = 3;
        for (const stone of state.winningStones) {
          const px = PADDING + stone.x * CELL_SIZE;
          const py = PADDING + stone.y * CELL_SIZE;
          ctx.beginPath();
          ctx.arc(px, py, CELL_SIZE * 0.4 + 3, 0, Math.PI * 2);
          ctx.stroke();
        }
      }
    }

    function drawStone(x, y, color) {
      const px = PADDING + x * CELL_SIZE;
      const py = PADDING + y * CELL_SIZE;
      const radius = CELL_SIZE * 0.4;
      
      // é˜´å½±
      ctx.beginPath();
      ctx.arc(px + 2, py + 2, radius, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fill();
      
      // æ£‹å­æ¸å˜
      const gradient = ctx.createRadialGradient(px - radius/3, py - radius/3, 0, px, py, radius);
      if (color === 1) { // é»‘æ£‹
        gradient.addColorStop(0, '#4a4a4a');
        gradient.addColorStop(1, '#1a1a1a');
      } else { // ç™½æ£‹
        gradient.addColorStop(0, '#ffffff');
        gradient.addColorStop(1, '#d0d0d0');
      }
      
      ctx.beginPath();
      ctx.arc(px, py, radius, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
      
      if (color === 2) {
        ctx.strokeStyle = '#999';
        ctx.lineWidth = 1;
        ctx.stroke();
      }
    }

    function getIntersection(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      
      const gridX = Math.round((x - PADDING) / CELL_SIZE);
      const gridY = Math.round((y - PADDING) / CELL_SIZE);
      
      if (gridX >= 0 && gridX < BOARD_SIZE && gridY >= 0 && gridY < BOARD_SIZE) {
        return { x: gridX, y: gridY };
      }
      return null;
    }

    // ==================== Socket äº‹ä»¶ ====================
    function initSocket() {
      state.socket = io();
      
      state.socket.on('connect', () => {
        console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        // å¦‚æœæœ‰ä¿å­˜çš„æ˜µç§°ï¼Œè‡ªåŠ¨åŠ å…¥å¤§å…
        const savedNickname = localStorage.getItem('gomoku_nickname');
        if (savedNickname) {
          nicknameInput.value = savedNickname;
        }
      });
      
      state.socket.on('disconnect', () => {
        showToast('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
      });
      
      state.socket.on('error', ({ message }) => {
        showToast(message);
      });
      
      state.socket.on('online-count', ({ count }) => {
        onlineCount.textContent = count;
      });
      
      state.socket.on('room-list', (rooms) => {
        updateRoomList(rooms);
      });
      
      state.socket.on('room-joined', ({ room, role }) => {
        state.currentRoom = room;
        state.myRole = role;
        state.board = room.board;
        state.lastMove = room.history.length > 0 ? room.history[room.history.length - 1] : null;
        state.winningStones = null;
        
        showView(gameView);
        updateGameUI();
        renderBoard();
      });
      
      state.socket.on('room-updated', (room) => {
        state.currentRoom = room;
        state.board = room.board;
        state.lastMove = room.history.length > 0 ? room.history[room.history.length - 1] : null;
        updateGameUI();
        renderBoard();
      });
      
      state.socket.on('stone-placed', ({ x, y, color }) => {
        if (state.board) {
          state.board[x][y] = color;
          state.lastMove = { x, y };
          renderBoard();
        }
      });
      
      state.socket.on('game-over', ({ winner, winningStones, surrender }) => {
        state.winningStones = winningStones;
        renderBoard();
        
        const winnerText = winner === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹';
        const resultText = $('resultText');
        const resultDetail = $('resultDetail');
        
        resultText.textContent = `${winnerText}è·èƒœï¼`;
        resultText.className = winner === 1 ? 'winner-black' : 'winner-white';
        resultDetail.textContent = surrender ? 'å¯¹æ–¹è®¤è¾“' : 'äº”å­è¿ç ';
        
        $('resultModal').classList.add('active');
      });
      
      state.socket.on('player-joined', ({ nickname, role }) => {
        showToast(`${nickname} åŠ å…¥äº†æˆ¿é—´`);
      });
      
      state.socket.on('player-left', ({ nickname }) => {
        showToast(`${nickname} ç¦»å¼€äº†æˆ¿é—´`);
      });
      
      state.socket.on('undo-requested', ({ from }) => {
        $('undoRequester').textContent = from;
        $('undoRequestModal').classList.add('active');
      });
      
      state.socket.on('undo-result', ({ accepted }) => {
        if (accepted) {
          showToast('æ‚”æ£‹æˆåŠŸ');
        } else {
          showToast('æ‚”æ£‹è¢«æ‹’ç»');
        }
      });
      
      state.socket.on('chat-received', (msg) => {
        addChatMessage(msg);
      });
    }

    // ==================== UI æ›´æ–° ====================
    function updateRoomList(rooms) {
      if (rooms.length === 0) {
        roomListBody.innerHTML = '<tr><td colspan="7" class="empty-list">æš‚æ— æˆ¿é—´</td></tr>';
        return;
      }
      
      roomListBody.innerHTML = rooms.map(room => {
        const statusClass = `status-${room.status}`;
        const statusText = { waiting: 'ç­‰å¾…ä¸­', playing: 'å¯¹æˆ˜ä¸­', ended: 'å·²ç»“æŸ' }[room.status];
        const canJoin = room.status === 'waiting' && (!room.blackPlayer || !room.whitePlayer);
        
        return `
          <tr>
            <td>${room.id}</td>
            <td>${room.name}</td>
            <td>${room.blackPlayer || '<span class="waiting-text">ç©ºä½</span>'}</td>
            <td>${room.whitePlayer || '<span class="waiting-text">ç©ºä½</span>'}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>${room.watcherCount}</td>
            <td>
              ${canJoin ? `<button class="btn btn-success btn-sm" onclick="joinRoom('${room.id}', false)">åŠ å…¥</button>` : ''}
              <button class="btn btn-outline btn-sm" onclick="joinRoom('${room.id}', true)">è§‚æˆ˜</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateGameUI() {
      const room = state.currentRoom;
      if (!room) return;
      
      $('roomName').textContent = room.name;
      $('roomId').textContent = room.id;
      
      // ç©å®¶ä¿¡æ¯
      const blackEl = $('blackPlayer');
      const whiteEl = $('whitePlayer');
      
      blackEl.querySelector('.player-name').textContent = room.players.black?.nickname || 'ç­‰å¾…åŠ å…¥...';
      blackEl.querySelector('.player-name').className = room.players.black ? 'player-name' : 'player-name waiting-text';
      
      whiteEl.querySelector('.player-name').textContent = room.players.white?.nickname || 'ç­‰å¾…åŠ å…¥...';
      whiteEl.querySelector('.player-name').className = room.players.white ? 'player-name' : 'player-name waiting-text';
      
      // å½“å‰å›åˆé«˜äº®
      blackEl.classList.toggle('active', room.currentTurn === 1 && room.status === 'playing');
      whiteEl.classList.toggle('active', room.currentTurn === 2 && room.status === 'playing');
      
      // è§‚æˆ˜è€…
      $('watcherCount').textContent = room.watchers.length;
      $('watcherList').textContent = room.watchers.length > 0 
        ? room.watchers.map(w => w.nickname).join(', ')
        : '-';
      
      // èŠå¤©è®°å½•
      const chatEl = $('chatMessages');
      chatEl.innerHTML = room.chat.map(msg => 
        `<div class="chat-message"><span class="chat-time">[${msg.time}]</span> <span class="chat-nick">${msg.nickname}:</span> ${msg.message}</div>`
      ).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addChatMessage(msg) {
      const chatEl = $('chatMessages');
      chatEl.innerHTML += `<div class="chat-message"><span class="chat-time">[${msg.time}]</span> <span class="chat-nick">${msg.nickname}:</span> ${msg.message}</div>`;
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // ==================== äº‹ä»¶å¤„ç† ====================
    function joinLobby() {
      const nickname = nicknameInput.value.trim();
      if (!nickname) {
        showToast('è¯·è¾“å…¥æ˜µç§°');
        return;
      }
      if (nickname.length > 20) {
        showToast('æ˜µç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
        return;
      }
      
      state.nickname = nickname;
      localStorage.setItem('gomoku_nickname', nickname);
      state.socket.emit('join-lobby', { nickname });
      lobbyContent.style.display = 'block';
      nicknameInput.disabled = true;
      $('joinLobbyBtn').disabled = true;
    }

    function createRoom() {
      const name = $('roomNameInput').value.trim() || `${state.nickname}çš„æˆ¿é—´`;
      state.socket.emit('create-room', { name });
      $('createRoomModal').classList.remove('active');
      $('roomNameInput').value = '';
    }

    function joinRoom(roomId, asWatcher) {
      state.socket.emit('join-room', { roomId, asWatcher });
    }

    function leaveRoom() {
      if (state.currentRoom) {
        state.socket.emit('leave-room', { roomId: state.currentRoom.id });
        state.currentRoom = null;
        state.myRole = null;
        state.board = null;
        state.lastMove = null;
        state.winningStones = null;
        showView(lobbyView);
      }
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    $('joinLobbyBtn').onclick = joinLobby;
    nicknameInput.onkeypress = e => { if (e.key === 'Enter') joinLobby(); };
    
    $('createRoomBtn').onclick = () => {
      $('roomNameInput').value = `${state.nickname}çš„æˆ¿é—´`;
      $('createRoomModal').classList.add('active');
    };
    $('cancelCreateBtn').onclick = () => $('createRoomModal').classList.remove('active');
    $('confirmCreateBtn').onclick = createRoom;
    
    $('quickMatchBtn').onclick = () => state.socket.emit('quick-match');
    $('refreshBtn').onclick = () => state.socket.emit('refresh-rooms');
    
    $('leaveRoomBtn').onclick = leaveRoom;
    $('undoBtn').onclick = () => {
      if (state.currentRoom) {
        state.socket.emit('request-undo', { roomId: state.currentRoom.id });
      }
    };
    $('surrenderBtn').onclick = () => {
      if (state.currentRoom && confirm('ç¡®å®šè¦è®¤è¾“å—ï¼Ÿ')) {
        state.socket.emit('surrender', { roomId: state.currentRoom.id });
      }
    };
    
    $('acceptUndoBtn').onclick = () => {
      state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: true });
      $('undoRequestModal').classList.remove('active');
    };
    $('rejectUndoBtn').onclick = () => {
      state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: false });
      $('undoRequestModal').classList.remove('active');
    };
    
    $('closeResultBtn').onclick = () => $('resultModal').classList.remove('active');
    
    // èŠå¤©
    $('sendChatBtn').onclick = () => {
      const input = $('chatInput');
      const msg = input.value.trim();
      if (msg && state.currentRoom) {
        state.socket.emit('chat-message', { roomId: state.currentRoom.id, message: msg });
        input.value = '';
      }
    };
    $('chatInput').onkeypress = e => { if (e.key === 'Enter') $('sendChatBtn').click(); };
    
    // æ£‹ç›˜ç‚¹å‡»
    canvas.onclick = (e) => {
      if (!state.currentRoom || state.currentRoom.status !== 'playing') return;
      if (state.myRole === 'watcher') return;
      
      const pos = getIntersection(e.clientX, e.clientY);
      if (pos) {
        state.socket.emit('place-stone', { roomId: state.currentRoom.id, x: pos.x, y: pos.y });
      }
    };
    
    // å“åº”å¼
    window.onresize = resizeBoard;
    
    // ==================== åˆå§‹åŒ– ====================
    initSocket();
    resizeBoard();
  </script>
</body>
</html>
