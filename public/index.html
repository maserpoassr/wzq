<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>äº‘ç«¯äº”å­æ£‹ - Gomoku Zen</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ================= å˜é‡ä¸é‡ç½® ================= */
    :root {
      --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.5);
      --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.1);
      
      --primary: #4a5568; /* é«˜çº§ç° */
      --accent: #d69e2e; /* é‡‘è‰²ç‚¹ç¼€ */
      --success: #48bb78;
      --danger: #f56565;
      
      --text-main: #2d3748;
      --text-sub: #718096;
      
      --board-color: #eebb77;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Nunito', 'Noto Serif SC', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* ================= å¸ƒå±€ç»„ä»¶ ================= */
    /* æ¯›ç»ç’ƒå¡ç‰‡åŸºç±» */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.5rem;
      flex: 1;
      width: 100%;
    }

    /* å¤´éƒ¨ */
    .header {
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1280px;
      margin: 0 auto;
      width: 100%;
    }
    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-main);
      letter-spacing: 1px;
    }
    .online-badge {
      background: white;
      padding: 0.4rem 1rem;
      border-radius: 50px;
      font-size: 0.9rem;
      color: var(--success);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .online-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      display: block;
    }

    /* è§†å›¾åˆ‡æ¢ */
    .view { display: none; opacity: 0; transition: opacity 0.3s ease; }
    .view.active { display: block; opacity: 1; }

    /* ================= å¤§å…è§†å›¾ ================= */
    .lobby-container {
      max-width: 800px;
      margin: 2rem auto;
    }

    .welcome-card {
      text-align: center;
      padding: 3rem 2rem;
      margin-bottom: 2rem;
    }

    .nickname-input-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    input[type="text"] {
      padding: 0.8rem 1.5rem;
      border: 2px solid transparent;
      background: white;
      border-radius: 12px;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
      width: 250px;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(214, 158, 46, 0.1);
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 0.8rem 1.8rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn:active { transform: scale(0.96); }
    
    .btn-primary { 
      background: var(--text-main); 
      color: white; 
      box-shadow: 0 4px 12px rgba(45, 55, 72, 0.3);
    }
    .btn-primary:hover { background: #1a202c; transform: translateY(-1px); }
    
    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px rgba(214, 158, 46, 0.3);
    }
    .btn-accent:hover { filter: brightness(1.1); transform: translateY(-1px); }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--text-main);
      color: var(--text-main);
    }
    .btn-outline:hover { background: var(--text-main); color: white; }

    .btn-danger { background: #fff; color: var(--danger); border: 1px solid #fed7d7; }
    .btn-danger:hover { background: #fff5f5; }

    /* æˆ¿é—´åˆ—è¡¨ */
    .action-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .room-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .room-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.03);
    }
    .room-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    .room-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 4px; height: 100%;
      background: var(--text-sub);
    }
    .room-card.status-waiting::before { background: var(--success); }
    .room-card.status-playing::before { background: var(--accent); }
    
    .room-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .room-id { font-size: 0.8rem; color: var(--text-sub); font-family: monospace; }
    .room-status { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
    .status-waiting .room-status { color: var(--success); }
    .status-playing .room-status { color: var(--accent); }
    
    .room-players {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }
    .player-slot { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot-black { background: #2d3748; }
    .dot-white { background: #fff; border: 1px solid #cbd5e0; }

    /* ================= æ¸¸æˆè§†å›¾ ================= */
    .game-layout {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 2rem;
      align-items: start;
    }

    /* ä¾§è¾¹æ  */
    .side-panel {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      height: 100%;
    }

    .panel-header {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 0.5rem;
    }

    /* ç©å®¶å¡ç‰‡ */
    .player-card {
      background: rgba(255,255,255,0.6);
      padding: 1rem;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    .player-card.active {
      background: white;
      border-color: var(--accent);
      box-shadow: 0 4px 15px rgba(214, 158, 46, 0.2);
      transform: scale(1.02);
    }
    .avatar-stone {
      width: 40px; 
      height: 40px; 
      border-radius: 50%;
      box-shadow: 2px 4px 6px rgba(0,0,0,0.2);
    }
    .avatar-black { background: radial-gradient(circle at 30% 30%, #555, #000); }
    .avatar-white { background: radial-gradient(circle at 30% 30%, #fff, #ddd); border: 1px solid rgba(0,0,0,0.1); }
    
    .player-info h4 { font-size: 1rem; margin-bottom: 0.2rem; }
    .thinking-badge {
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 600;
      opacity: 0;
      transform: translateY(5px);
      transition: all 0.3s;
    }
    .player-card.active .thinking-badge { opacity: 1; transform: translateY(0); }
    
    /* å€’è®¡æ—¶æ ·å¼ */
    .timer-badge {
      margin-left: auto;
      min-width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #e6a800);
      color: white;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(214, 158, 46, 0.4);
      animation: pulse 1s infinite;
    }
    .timer-badge.warning {
      background: linear-gradient(135deg, var(--danger), #e53e3e);
      box-shadow: 0 2px 8px rgba(245, 101, 101, 0.4);
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* æ£‹ç›˜å®¹å™¨ */
    .board-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    canvas {
      border-radius: 4px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      cursor: pointer;
      /* æœ¨çº¹èƒŒæ™¯ç”± JS ç»˜åˆ¶ï¼Œè¿™é‡Œä»…ä½œä¸º fallback */
      background: #DEB887; 
      transition: transform 0.3s;
    }

    /* èŠå¤©ä¸æ“ä½œ */
    .chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }
    .chat-history {
      flex: 1;
      overflow-y: auto;
      background: rgba(255,255,255,0.4);
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 0.8rem;
      font-size: 0.9rem;
      border: 1px solid rgba(0,0,0,0.03);
    }
    .message { margin-bottom: 0.5rem; line-height: 1.4; }
    .message .time { color: var(--text-sub); font-size: 0.75rem; margin-right: 4px; }
    .message .nick { font-weight: 700; color: var(--text-main); }
    
    .chat-input-area { display: flex; gap: 0.5rem; }
    .chat-input-area input { flex: 1; padding: 0.6rem; font-size: 0.9rem; }

    /* ================= å¼¹çª— ================= */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    .modal {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    
    .modal h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .modal p { color: var(--text-sub); margin-bottom: 1.5rem; }
    
    .result-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(45, 55, 72, 0.95);
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      font-size: 0.9rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ================= å“åº”å¼ ================= */
    @media (max-width: 1024px) {
      .game-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        gap: 1rem;
      }
      .board-wrapper { order: 1; }
      .side-panel:nth-child(1) { order: 0; flex-direction: row; justify-content: space-between; padding: 1rem; }
      .side-panel:nth-child(3) { order: 2; }
      
      .player-card { flex: 1; justify-content: center; padding: 0.5rem; }
      .avatar-stone { width: 30px; height: 30px; }
      .thinking-badge { display: none; }
    }
    
    @media (max-width: 600px) {
      .header h1 { font-size: 1.2rem; }
      .online-badge { padding: 0.3rem 0.8rem; font-size: 0.8rem; }
      
      .side-panel:nth-child(1) { flex-direction: row; gap: 0.5rem; }
      .player-info h4 { font-size: 0.8rem; }
      .panel-header { display: none; }
      
      .room-grid { grid-template-columns: 1fr; }
      .nickname-input-group { flex-direction: column; align-items: stretch; }
      input[type="text"] { width: 100%; }
      
      .game-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>ğŸ”ï¸ Gomoku Zen</h1>
    <div class="online-badge">åœ¨çº¿: <span id="onlineCount">0</span></div>
  </div>

  <div class="container">
    
    <div id="lobbyView" class="view active">
      <div class="lobby-container">
        <div class="glass-card welcome-card">
          <h2 style="margin-bottom: 0.5rem; color: var(--text-main);">å¼€å¯å¯¹å¼ˆä¹‹æ—…</h2>
          <p style="color: var(--text-sub);">è¾“å…¥æ˜µç§°åŠ å…¥å…¨çƒå¯¹æˆ˜å¤§å…</p>
          <div class="nickname-input-group">
            <input type="text" id="nicknameInput" placeholder="ä½ çš„ä»£å·..." maxlength="12">
            <button class="btn btn-primary" id="joinLobbyBtn">
              <span>è¿›å…¥å¤§å…</span>
            </button>
          </div>
        </div>

        <div id="lobbyContent" style="display: none;">
          <div class="action-bar">
            <button class="btn btn-accent" id="createRoomBtn">ï¼‹ åˆ›å»ºæˆ¿é—´</button>
            <button class="btn btn-primary" id="quickMatchBtn">âš¡ å¿«é€ŸåŒ¹é…</button>
            <button class="btn btn-outline" id="refreshBtn" style="margin-left: auto;">â†» åˆ·æ–°</button>
          </div>

          <div id="roomListGrid" class="room-grid">
            <div class="glass-card" style="padding: 2rem; text-align: center; color: var(--text-sub); grid-column: 1/-1;">
              æ­£åœ¨åŠ è½½æˆ¿é—´æ•°æ®...
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="gameView" class="view">
      <div class="game-layout">
        
        <div class="glass-card side-panel">
          <div class="panel-header">å¯¹æˆ˜ä¿¡æ¯</div>
          <div style="font-size: 0.9rem; color: var(--text-sub); margin-bottom: 0.5rem;">
            æˆ¿é—´: <span id="roomName" style="color: var(--text-main); font-weight: bold;">-</span>
            <span style="opacity: 0.5; margin: 0 4px;">|</span>
            ID: <span id="roomId">-</span>
          </div>

          <div id="blackPlayer" class="player-card">
            <div class="avatar-stone avatar-black"></div>
            <div class="player-info">
              <h4 class="p-name">ç­‰å¾…åŠ å…¥...</h4>
              <div class="thinking-badge">æ€è€ƒä¸­...</div>
            </div>
            <div class="timer-badge" id="blackTimer" style="display: none;">30</div>
          </div>

          <div id="whitePlayer" class="player-card">
            <div class="avatar-stone avatar-white"></div>
            <div class="player-info">
              <h4 class="p-name">ç­‰å¾…åŠ å…¥...</h4>
              <div class="thinking-badge">æ€è€ƒä¸­...</div>
            </div>
            <div class="timer-badge" id="whiteTimer" style="display: none;">30</div>
          </div>
          
          <div style="margin-top: auto; font-size: 0.85rem; color: var(--text-sub);">
            è§‚æˆ˜è€…: <span id="watcherCount">0</span> äºº
          </div>
        </div>

        <div class="board-wrapper">
          <canvas id="board" width="500" height="500"></canvas>
        </div>

        <div class="glass-card side-panel">
          <div class="panel-header">æ§åˆ¶å°</div>
          
          <div class="game-actions" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button class="btn btn-outline" id="undoBtn" style="flex: 1; padding: 0.6rem;">æ‚”æ£‹</button>
            <button class="btn btn-outline" id="inviteBtn" style="flex: 1; padding: 0.6rem;">é‚€è¯·</button>
            <button class="btn btn-danger" id="surrenderBtn" style="flex: 1; padding: 0.6rem;">è®¤è¾“</button>
            <button class="btn btn-outline" id="leaveRoomBtn" style="width: 100%; padding: 0.6rem;">é€€å‡ºæˆ¿é—´</button>
          </div>

          <div class="chat-box" style="margin-top: 1.5rem;">
            <div class="panel-header">å®æ—¶èŠå¤©</div>
            <div class="chat-history" id="chatMessages"></div>
            <div class="chat-input-area">
              <input type="text" id="chatInput" placeholder="å‘é€æ¶ˆæ¯..." maxlength="200">
              <button class="btn btn-primary" id="sendChatBtn" style="padding: 0 1rem;">â†’</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal-overlay" id="createRoomModal">
    <div class="modal">
      <h2>åˆ›å»ºæ–°æˆ¿é—´</h2>
      <p>ç»™ä½ çš„æˆ˜åœºèµ·ä¸ªåå­—</p>
      <input type="text" id="roomNameInput" placeholder="ä¾‹å¦‚ï¼šå†³æˆ˜ç´«ç¦ä¹‹å·…" maxlength="20" style="width: 100%; margin-bottom: 1.5rem;">
      <div style="display: flex; gap: 1rem; justify-content: center;">
        <button class="btn btn-outline" id="cancelCreateBtn">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="confirmCreateBtn">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="resultModal">
    <div class="modal">
      <div class="result-icon">ğŸ†</div>
      <h2 id="resultText">æ¸¸æˆç»“æŸ</h2>
      <p id="resultDetail">èƒœè´Ÿå·²åˆ†</p>
      <button class="btn btn-primary" id="closeResultBtn" style="width: 100%">ç¡®è®¤</button>
    </div>
  </div>

  <div class="modal-overlay" id="gameEndModal">
    <div class="modal">
      <div class="result-icon" id="gameEndIcon">ğŸ</div>
      <h2 id="gameEndText">æ¸¸æˆç»“æŸ</h2>
      <p id="rematchStatus">æ˜¯å¦å†æ¥ä¸€å±€ï¼Ÿ</p>
      <div style="display: flex; flex-direction: column; gap: 0.8rem;">
        <button class="btn btn-success" id="rematchBtn" style="width: 100%">å†æ¥ä¸€å±€</button>
        <button class="btn btn-outline" id="leaveAfterGameBtn" style="width: 100%">ç¦»å¼€æˆ¿é—´</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="undoRequestModal">
    <div class="modal">
      <h2>æ‚”æ£‹è¯·æ±‚</h2>
      <p><span id="undoRequester" style="font-weight: bold;">å¯¹æ–¹</span> æƒ³è¦æ‚”æ£‹ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ</p>
      <div style="display: flex; gap: 1rem; justify-content: center;">
        <button class="btn btn-danger" id="rejectUndoBtn">æ®‹å¿æ‹’ç»</button>
        <button class="btn btn-primary" id="acceptUndoBtn">å¤§åº¦åŒæ„</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== çŠ¶æ€ç®¡ç† ====================
    const state = {
      socket: null,
      nickname: '',
      currentRoom: null,
      myRole: null,
      board: null,
      lastMove: null,
      winningStones: null,
      gameEnded: false,
      rematchRequested: false,
      pendingRoomId: null,
      turnTimer: null,
      timeRemaining: 30,
      hoverPos: null  // é¼ æ ‡æ‚¬åœä½ç½®ï¼ˆé¢„é€‰æ¡†ï¼‰
    };

    // ==================== DOM å…ƒç´  ====================
    const $ = id => document.getElementById(id);
    const canvas = $('board');
    const ctx = canvas.getContext('2d');

    // ==================== å¢å¼ºç‰ˆ UI æ¸²æŸ“ ====================
    
    // 1. æˆ¿é—´åˆ—è¡¨æ¸²æŸ“ (Grid Layout)
    function renderRoomList(rooms) {
      const grid = $('roomListGrid');
      if (rooms.length === 0) {
        grid.innerHTML = `
          <div class="glass-card" style="grid-column: 1/-1; padding: 3rem; text-align: center; color: var(--text-sub);">
            <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸƒ</div>
            <p>æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</p>
          </div>`;
        return;
      }

      grid.innerHTML = rooms.map(room => {
        const isFull = room.blackPlayer && room.whitePlayer;
        const statusClass = `status-${room.status}`;
        const canJoin = room.status === 'waiting' && !isFull;
        
        // åŠ¨æ€ç”ŸæˆåŠ å…¥/è§‚æˆ˜æŒ‰é’®
        let actionBtn = '';
        if (canJoin) {
          actionBtn = `<button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="joinRoom('${room.id}', false)">âš”ï¸ åŠ å…¥å¯¹æˆ˜</button>`;
        }
        
        return `
          <div class="room-card ${statusClass}">
            <div class="room-header">
              <span style="font-weight: bold; font-size: 1.1rem;">${room.name}</span>
              <span class="room-status">${room.status === 'playing' ? 'å¯¹æˆ˜ä¸­' : 'ç­‰å¾…ä¸­'}</span>
            </div>
            
            <div class="room-players">
              <div class="player-slot">
                <div class="dot dot-black"></div>
                <span>${room.blackPlayer || 'ç©ºä½'}</span>
              </div>
              <div class="player-slot">
                <div class="dot dot-white"></div>
                <span>${room.whitePlayer || 'ç©ºä½'}</span>
              </div>
            </div>

            <div style="margin-top: 1rem;">
              ${actionBtn}
              <button class="btn btn-outline" style="width: 100%; font-size: 0.85rem;" onclick="joinRoom('${room.id}', true)">ğŸ‘ï¸ è§‚æˆ˜ (${room.watcherCount})</button>
            </div>
            <div class="room-id" style="margin-top: 0.8rem; text-align: center;">ID: ${room.id}</div>
          </div>
        `;
      }).join('');
    }

    // 2. æ ¸å¿ƒ Canvas æ¸²æŸ“ (é«˜æ¸…æœ¨çº¹ + 3Dæ£‹å­)
    const BOARD_SIZE = 15;
    const PADDING = 30;
    let CELL_SIZE = 30;

    function resizeBoard() {
      // å“åº”å¼è®¡ç®—
      const containerW = canvas.parentElement.clientWidth;
      const size = Math.min(containerW, 550); // æœ€å¤§550px
      
      // å¤„ç†é«˜DPIå±å¹• (Retina)
      const dpr = window.devicePixelRatio || 1;
      canvas.width = size * dpr;
      canvas.height = size * dpr;
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      
      ctx.scale(dpr, dpr);
      
      CELL_SIZE = (size - PADDING * 2) / (BOARD_SIZE - 1);
      renderBoard();
    }

    function renderBoard() {
      const width = parseFloat(canvas.style.width);
      const height = parseFloat(canvas.style.height);

      // A. ç»˜åˆ¶é«˜çº§æœ¨çº¹èƒŒæ™¯
      const grd = ctx.createLinearGradient(0, 0, width, height);
      grd.addColorStop(0, "#eebb77");
      grd.addColorStop(1, "#cd9b55");
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, width, height);

      // è¾¹æ¡†è£…é¥°
      ctx.strokeStyle = "#8B4513";
      ctx.lineWidth = 2;
      ctx.strokeRect(PADDING - 10, PADDING - 10, width - (PADDING - 10)*2, height - (PADDING - 10)*2);

      // B. ç»˜åˆ¶ç½‘æ ¼
      ctx.beginPath();
      ctx.lineWidth = 1;
      ctx.strokeStyle = "#5e4020";
      
      for (let i = 0; i < BOARD_SIZE; i++) {
        const pos = PADDING + i * CELL_SIZE;
        // æ¨ªçº¿
        ctx.moveTo(PADDING, pos);
        ctx.lineTo(width - PADDING, pos);
        // ç«–çº¿
        ctx.moveTo(pos, PADDING);
        ctx.lineTo(pos, height - PADDING);
      }
      ctx.stroke();

      // C. ç»˜åˆ¶æ˜Ÿä½ (å¤©å…ƒç­‰)
      const starPoints = [3, 7, 11];
      ctx.fillStyle = "#5e4020";
      for (const x of starPoints) {
        for (const y of starPoints) {
          ctx.beginPath();
          ctx.arc(PADDING + x * CELL_SIZE, PADDING + y * CELL_SIZE, 3, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // D. ç»˜åˆ¶æ£‹å­
      if (state.board) {
        for (let x = 0; x < BOARD_SIZE; x++) {
          for (let y = 0; y < BOARD_SIZE; y++) {
            if (state.board[x][y] !== 0) {
              drawRealisticStone(x, y, state.board[x][y]);
            }
          }
        }
      }

      // E. é«˜äº®æœ€åè½å­
      if (state.lastMove) {
        const { x, y } = state.lastMove;
        const px = PADDING + x * CELL_SIZE;
        const py = PADDING + y * CELL_SIZE;
        
        // çº¢è‰²æ ‡è®°
        ctx.fillStyle = "rgba(231, 76, 60, 0.9)";
        ctx.beginPath();
        ctx.arc(px, py, 4, 0, Math.PI * 2);
        ctx.fill();
        
        // å¤–åœˆæŒ‡ç¤º
        ctx.strokeStyle = "rgba(231, 76, 60, 0.6)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(px, py, CELL_SIZE * 0.45, 0, Math.PI * 2);
        ctx.stroke();
      }

      // F. é«˜äº®è·èƒœè¿çº¿
      if (state.winningStones) {
        ctx.beginPath();
        ctx.strokeStyle = "#d69e2e"; // é‡‘è‰²
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        
        // ç”»çº¿è¿æ¥äº”ä¸ªå­
        const start = state.winningStones[0];
        const end = state.winningStones[4];
        
        ctx.moveTo(PADDING + start.x * CELL_SIZE, PADDING + start.y * CELL_SIZE);
        ctx.lineTo(PADDING + end.x * CELL_SIZE, PADDING + end.y * CELL_SIZE);
        ctx.stroke();
      }
      
      // G. ç»˜åˆ¶é¢„é€‰æ¡†ï¼ˆé¼ æ ‡æ‚¬åœä½ç½®ï¼‰
      if (state.hoverPos && state.currentRoom && state.currentRoom.status === 'playing' && state.myRole !== 'watcher') {
        const { x, y } = state.hoverPos;
        // åªåœ¨ç©ºä½æ˜¾ç¤ºé¢„é€‰æ¡†
        if (state.board && state.board[x][y] === 0) {
          const px = PADDING + x * CELL_SIZE;
          const py = PADDING + y * CELL_SIZE;
          const r = CELL_SIZE * 0.42;
          
          // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯è‡ªå·±çš„å›åˆ
          const isMyTurn = (state.myRole === 'black' && state.currentRoom.currentTurn === 1) ||
                           (state.myRole === 'white' && state.currentRoom.currentTurn === 2);
          
          if (isMyTurn) {
            // ç»˜åˆ¶åŠé€æ˜é¢„é€‰æ£‹å­
            ctx.globalAlpha = 0.5;
            const myColor = state.myRole === 'black' ? 1 : 2;
            
            const grad = ctx.createRadialGradient(px - r/3, py - r/3, r/10, px, py, r);
            if (myColor === 1) {
              grad.addColorStop(0, "#666");
              grad.addColorStop(1, "#050505");
            } else {
              grad.addColorStop(0, "#fff");
              grad.addColorStop(1, "#ccc");
            }
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(px, py, r, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.globalAlpha = 1;
          }
          
          // ç»˜åˆ¶é¢„é€‰æ¡†è¾¹æ¡†
          ctx.strokeStyle = isMyTurn ? "rgba(72, 187, 120, 0.8)" : "rgba(160, 160, 160, 0.5)";
          ctx.lineWidth = 2;
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.arc(px, py, r + 2, 0, Math.PI * 2);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }
    }

    // ç»˜åˆ¶ 3D è´¨æ„Ÿæ£‹å­
    function drawRealisticStone(x, y, color) {
      const px = PADDING + x * CELL_SIZE;
      const py = PADDING + y * CELL_SIZE;
      const r = CELL_SIZE * 0.42;

      // 1. é˜´å½±
      ctx.shadowColor = "rgba(0, 0, 0, 0.4)";
      ctx.shadowBlur = 6;
      ctx.shadowOffsetX = 3;
      ctx.shadowOffsetY = 3;
      
      ctx.beginPath();
      ctx.arc(px, py, r, 0, Math.PI * 2);
      ctx.fillStyle = color === 1 ? "#000" : "#fff"; // åŸºç¡€å¡«å……ç”¨äºé˜´å½±
      ctx.fill();
      
      // é‡ç½®é˜´å½±ä»¥å…å½±å“åç»­ç»˜åˆ¶
      ctx.shadowColor = "transparent";

      // 2. æ£‹å­æœ¬ä½“æ¸å˜
      const grad = ctx.createRadialGradient(
        px - r/3, py - r/3, r/10, // å…‰æºä½ç½®
        px, py, r                 // æ•´ä½“
      );

      if (color === 1) { 
        // é»‘å­ï¼šé»‘ç›ç‘™è´¨æ„Ÿ
        grad.addColorStop(0, "#666"); // é«˜å…‰
        grad.addColorStop(0.3, "#222");
        grad.addColorStop(1, "#050505");
      } else { 
        // ç™½å­ï¼šè´å£³è´¨æ„Ÿ
        grad.addColorStop(0, "#fff");
        grad.addColorStop(0.3, "#f0f0f0");
        grad.addColorStop(1, "#ccc");
      }

      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(px, py, r, 0, Math.PI * 2);
      ctx.fill();
    }

    // åæ ‡è½¬æ¢
    function getIntersection(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / (rect.width * (window.devicePixelRatio || 1));
      
      // è°ƒæ•´ç‚¹å‡»ä½ç½®ç›¸å¯¹äº Canvas å†…éƒ¨å°ºå¯¸
      const x = (clientX - rect.left) * (window.devicePixelRatio || 1);
      const y = (clientY - rect.top) * (window.devicePixelRatio || 1);

      // åå‘è®¡ç®—ç½‘æ ¼åæ ‡
      const realPadding = PADDING * (window.devicePixelRatio || 1);
      const realCellSize = CELL_SIZE * (window.devicePixelRatio || 1);
      
      // å¢åŠ åˆ¤å®šèŒƒå›´ï¼Œä½¿è§¦æ‘¸æ›´å‹å¥½
      const gridX = Math.round((x - realPadding) / realCellSize);
      const gridY = Math.round((y - realPadding) / realCellSize);

      if (gridX >= 0 && gridX < BOARD_SIZE && gridY >= 0 && gridY < BOARD_SIZE) {
        // è·ç¦»æ£€æŸ¥ï¼Œé˜²æ­¢ç‚¹åˆ°ä¸¤ä¸ªç‚¹ä¸­é—´
        const centerX = realPadding + gridX * realCellSize;
        const centerY = realPadding + gridY * realCellSize;
        const dist = Math.sqrt((x - centerX)**2 + (y - centerY)**2);
        
        if (dist < realCellSize * 0.45) {
          return { x: gridX, y: gridY };
        }
      }
      return null;
    }

    // ==================== é€»è¾‘æ§åˆ¶ (ä¿æŒåŸæœ‰é€»è¾‘æ¡†æ¶) ====================
    function showToast(msg, duration = 2000) {
      const toast = $('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      $(viewId).classList.add('active');
    }

    function updateGameUI() {
      const room = state.currentRoom;
      if (!room) return;
      
      $('roomName').textContent = room.name;
      $('roomId').textContent = room.id;
      
      // ç©å®¶ä¿¡æ¯æ›´æ–°
      updatePlayerCard('black', room.players.black, room.currentTurn === 1 && room.status === 'playing');
      updatePlayerCard('white', room.players.white, room.currentTurn === 2 && room.status === 'playing');
      
      $('watcherCount').textContent = room.watchers.length;
      
      // èŠå¤©è®°å½•
      const chatEl = $('chatMessages');
      chatEl.innerHTML = room.chat.map(msg => 
        `<div class="message">
           <span class="time">${msg.time}</span>
           <span class="nick">${msg.nickname}:</span>
           <span>${msg.message}</span>
         </div>`
      ).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function updatePlayerCard(color, player, isActive) {
      const el = $(`${color}Player`);
      const nameEl = el.querySelector('.p-name');
      
      if (player) {
        nameEl.textContent = player.nickname;
        el.style.opacity = '1';
      } else {
        nameEl.textContent = 'ç­‰å¾…åŠ å…¥...';
        el.style.opacity = '0.6';
      }
      
      if (isActive) {
        el.classList.add('active');
      } else {
        el.classList.remove('active');
      }
    }

    function initSocket() {
      state.socket = io();
      
      state.socket.on('connect', () => {
        const savedNickname = localStorage.getItem('gomoku_nickname');
        if (savedNickname) $('nicknameInput').value = savedNickname;
      });
      
      state.socket.on('disconnect', () => showToast('âš ï¸ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥'));
      state.socket.on('error', ({ message }) => showToast(`âŒ ${message}`));
      state.socket.on('online-count', ({ count }) => $('onlineCount').textContent = count);
      
      // æˆ¿é—´åˆ—è¡¨æ›´æ–°
      state.socket.on('room-list', (rooms) => renderRoomList(rooms));
      
      // æ¸¸æˆçŠ¶æ€æ›´æ–°
      state.socket.on('room-joined', ({ room, role }) => {
        state.currentRoom = room;
        state.myRole = role;
        state.board = room.board;
        state.lastMove = room.history.length > 0 ? room.history[room.history.length - 1] : null;
        state.winningStones = null;
        state.gameEnded = false;
        
        showView('gameView');
        setTimeout(resizeBoard, 100); // ç¡®ä¿å®¹å™¨å°ºå¯¸æ­£ç¡®åæ¸²æŸ“
        updateGameUI();
      });
      
      state.socket.on('room-updated', (room) => {
        state.currentRoom = room;
        state.board = room.board;
        state.lastMove = room.history.length > 0 ? room.history[room.history.length - 1] : null;
        updateGameUI();
        renderBoard();
      });

      state.socket.on('stone-placed', ({ x, y, color }) => {
        if (state.board) {
          state.board[x][y] = color;
          state.lastMove = { x, y };
          renderBoard();
        }
      });
      
      state.socket.on('game-over', ({ winner, winningStones, surrender }) => {
        state.winningStones = winningStones;
        state.gameEnded = true;
        state.rematchRequested = false;
        stopClientTimer();
        renderBoard();
        
        const winnerText = winner === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹';
        $('resultText').textContent = `${winnerText}è·èƒœï¼`;
        $('resultDetail').textContent = surrender ? 'å¯¹æ–¹å·²è®¤è¾“' : 'äº”æ˜Ÿè¿ç ï¼Œç²¾å½©ç»ä¼¦';
        $('resultModal').classList.add('active');
      });

      // èŠå¤©
      state.socket.on('chat-received', (msg) => {
        const chatEl = $('chatMessages');
        chatEl.innerHTML += `
          <div class="message">
             <span class="time">${msg.time}</span>
             <span class="nick">${msg.nickname}:</span>
             <span>${msg.message}</span>
          </div>`;
        chatEl.scrollTop = chatEl.scrollHeight;
      });

      // è¾…åŠ©åŠŸèƒ½
      state.socket.on('player-joined', ({ nickname }) => showToast(`${nickname} è¿›å…¥æˆ¿é—´`));
      state.socket.on('player-left', ({ nickname }) => showToast(`${nickname} ç¦»å¼€æˆ¿é—´`));
      
      state.socket.on('room-closed', ({ reason }) => {
        showToast(reason);
        resetGameState();
      });

      // æ‚”æ£‹ä¸å†æ¥ä¸€å±€
      state.socket.on('undo-requested', ({ from }) => {
        $('undoRequester').textContent = from;
        $('undoRequestModal').classList.add('active');
      });
      
      state.socket.on('undo-result', ({ accepted }) => showToast(accepted ? 'æ‚”æ£‹æˆåŠŸ' : 'å¯¹æ–¹æ‹’ç»äº†æ‚”æ£‹'));
      
      state.socket.on('rematch-waiting', () => {
        state.rematchRequested = true;
        $('rematchBtn').textContent = 'ç­‰å¾…å¯¹æ–¹ç¡®è®¤...';
        $('rematchBtn').disabled = true;
      });
      
      state.socket.on('rematch-start', ({ swapped, message }) => {
        state.gameEnded = false;
        state.rematchRequested = false;
        state.winningStones = null;
        $('gameEndModal').classList.remove('active');
        $('rematchBtn').textContent = 'å†æ¥ä¸€å±€';
        $('rematchBtn').disabled = false;
        showToast(message || 'æ–°å¯¹å±€å¼€å§‹');
        if (swapped) state.myRole = state.myRole === 'black' ? 'white' : 'black';
      });
      
      // å›åˆè®¡æ—¶å™¨äº‹ä»¶
      state.socket.on('turn-timer-start', ({ timeLimit, currentTurn }) => {
        startClientTimer(timeLimit, currentTurn);
      });
      
      state.socket.on('timeout-auto-place', ({ x, y, color }) => {
        showToast('â° è¶…æ—¶è‡ªåŠ¨è½å­');
      });
    }
    
    // å®¢æˆ·ç«¯è®¡æ—¶å™¨
    function startClientTimer(timeLimit, currentTurn) {
      // æ¸…é™¤æ—§è®¡æ—¶å™¨
      if (state.turnTimer) {
        clearInterval(state.turnTimer);
      }
      
      state.timeRemaining = Math.floor(timeLimit / 1000);
      
      // éšè—æ‰€æœ‰è®¡æ—¶å™¨
      $('blackTimer').style.display = 'none';
      $('whiteTimer').style.display = 'none';
      
      // æ˜¾ç¤ºå½“å‰å›åˆçš„è®¡æ—¶å™¨
      const timerEl = currentTurn === 1 ? $('blackTimer') : $('whiteTimer');
      timerEl.style.display = 'flex';
      timerEl.textContent = state.timeRemaining;
      timerEl.classList.remove('warning');
      
      // å¯åŠ¨å€’è®¡æ—¶
      state.turnTimer = setInterval(() => {
        state.timeRemaining--;
        timerEl.textContent = state.timeRemaining;
        
        // 10ç§’ä»¥ä¸‹æ˜¾ç¤ºè­¦å‘Š
        if (state.timeRemaining <= 10) {
          timerEl.classList.add('warning');
        }
        
        // æ—¶é—´åˆ°
        if (state.timeRemaining <= 0) {
          clearInterval(state.turnTimer);
          state.turnTimer = null;
        }
      }, 1000);
    }
    
    function stopClientTimer() {
      if (state.turnTimer) {
        clearInterval(state.turnTimer);
        state.turnTimer = null;
      }
      $('blackTimer').style.display = 'none';
      $('whiteTimer').style.display = 'none';
    }

    function resetGameState() {
      state.currentRoom = null;
      state.myRole = null;
      state.board = null;
      state.gameEnded = false;
      stopClientTimer();
      document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
      showView('lobbyView');
    }

    function joinLobby() {
      const nickname = $('nicknameInput').value.trim();
      if (!nickname) return showToast('è¯·å…ˆè¾“å…¥æ˜µç§°');
      
      state.nickname = nickname;
      localStorage.setItem('gomoku_nickname', nickname);
      state.socket.emit('join-lobby', { nickname });
      
      // åŠ¨ç”»åˆ‡æ¢
      $('joinLobbyBtn').innerHTML = 'è¿›å…¥ä¸­...';
      setTimeout(() => {
        $('nicknameInput').parentElement.style.display = 'none';
        $('lobbyContent').style.display = 'block';
        if (state.pendingRoomId) {
          joinRoom(state.pendingRoomId, false);
          state.pendingRoomId = null;
        }
      }, 500);
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    $('joinLobbyBtn').onclick = joinLobby;
    $('nicknameInput').onkeypress = e => e.key === 'Enter' && joinLobby();
    
    // æˆ¿é—´æ“ä½œ
    $('createRoomBtn').onclick = () => {
      $('roomNameInput').value = `${state.nickname}çš„æ£‹å±€`;
      $('createRoomModal').classList.add('active');
    };
    $('cancelCreateBtn').onclick = () => $('createRoomModal').classList.remove('active');
    $('confirmCreateBtn').onclick = () => {
      const name = $('roomNameInput').value.trim() || `${state.nickname}çš„æ£‹å±€`;
      state.socket.emit('create-room', { name });
      $('createRoomModal').classList.remove('active');
    };
    $('quickMatchBtn').onclick = () => state.socket.emit('quick-match');
    $('refreshBtn').onclick = () => state.socket.emit('refresh-rooms');

    // æ¸¸æˆå†…æ“ä½œ
    window.joinRoom = (id, asWatcher) => state.socket.emit('join-room', { roomId: id, asWatcher });
    window.copyInviteLink = (roomId) => {
      const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('ğŸ“‹ é‚€è¯·é“¾æ¥å·²å¤åˆ¶');
      }).catch(() => {
        // é™çº§æ–¹æ¡ˆ
        const input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('ğŸ“‹ é‚€è¯·é“¾æ¥å·²å¤åˆ¶');
      });
    };

    $('leaveRoomBtn').onclick = () => {
      if(confirm('ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ')) {
        state.socket.emit('leave-room', { roomId: state.currentRoom.id });
        resetGameState();
      }
    };
    $('surrenderBtn').onclick = () => confirm('ç¡®å®šè®¤è¾“ï¼Ÿ') && state.socket.emit('surrender', { roomId: state.currentRoom.id });
    $('undoBtn').onclick = () => state.socket.emit('request-undo', { roomId: state.currentRoom.id });
    
    $('acceptUndoBtn').onclick = () => {
      state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: true });
      $('undoRequestModal').classList.remove('active');
    };
    $('rejectUndoBtn').onclick = () => {
      state.socket.emit('respond-undo', { roomId: state.currentRoom.id, accept: false });
      $('undoRequestModal').classList.remove('active');
    };

    $('closeResultBtn').onclick = () => {
      $('resultModal').classList.remove('active');
      if (['black', 'white'].includes(state.myRole)) {
        $('gameEndModal').classList.add('active');
      }
    };
    $('rematchBtn').onclick = () => {
      if (!state.rematchRequested) state.socket.emit('request-rematch', { roomId: state.currentRoom.id });
    };
    $('leaveAfterGameBtn').onclick = () => {
      state.socket.emit('leave-room', { roomId: state.currentRoom.id });
      resetGameState();
    };

    $('sendChatBtn').onclick = () => {
      const input = $('chatInput');
      if (input.value.trim() && state.currentRoom) {
        state.socket.emit('chat-message', { roomId: state.currentRoom.id, message: input.value.trim() });
        input.value = '';
      }
    };
    $('chatInput').onkeypress = e => e.key === 'Enter' && $('sendChatBtn').click();
    $('inviteBtn').onclick = () => {
      const url = `${window.location.origin}${window.location.pathname}?room=${state.currentRoom.id}`;
      navigator.clipboard.writeText(url).then(() => showToast('ğŸ“‹ é‚€è¯·é“¾æ¥å·²å¤åˆ¶'));
    };

    // Canvas ç‚¹å‡»äº¤äº’
    canvas.onclick = (e) => {
      if (!state.currentRoom || state.currentRoom.status !== 'playing' || state.myRole === 'watcher') return;
      const pos = getIntersection(e.clientX, e.clientY);
      if (pos) state.socket.emit('place-stone', { roomId: state.currentRoom.id, x: pos.x, y: pos.y });
    };
    
    // Canvas é¼ æ ‡ç§»åŠ¨ - é¢„é€‰æ¡†
    canvas.onmousemove = (e) => {
      if (!state.currentRoom || state.currentRoom.status !== 'playing' || state.myRole === 'watcher') {
        if (state.hoverPos) {
          state.hoverPos = null;
          renderBoard();
        }
        return;
      }
      
      const pos = getIntersection(e.clientX, e.clientY);
      
      // åªæœ‰ä½ç½®å˜åŒ–æ—¶æ‰é‡æ–°æ¸²æŸ“
      if (pos) {
        if (!state.hoverPos || state.hoverPos.x !== pos.x || state.hoverPos.y !== pos.y) {
          state.hoverPos = pos;
          renderBoard();
        }
      } else if (state.hoverPos) {
        state.hoverPos = null;
        renderBoard();
      }
    };
    
    // Canvas é¼ æ ‡ç¦»å¼€ - æ¸…é™¤é¢„é€‰æ¡†
    canvas.onmouseleave = () => {
      if (state.hoverPos) {
        state.hoverPos = null;
        renderBoard();
      }
    };

    // åˆå§‹åŒ–
    initSocket();
    window.addEventListener('resize', resizeBoard);
    
    // URL å‚æ•°æ£€æŸ¥
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('room')) {
      state.pendingRoomId = urlParams.get('room');
      window.history.replaceState({}, '', window.location.pathname);
    }
  </script>
</body>
</html>